#!/usr/bin/env python
"""
Создание тестовых курсов для тенанта «Ольга фарфоровые цветы».

Запуск:
    cd teaching_panel
    python manage.py shell -c "exec(open('create_olga_courses.py').read())"
"""
import os, sys, django

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'teaching_panel.settings')
django.setup()

from django.db import transaction
from tenants.models import Tenant
from accounts.models import CustomUser
from core.models import Course, CourseLesson, CourseLessonMaterial, CourseAccess


def create_olga_courses():
    tenant_slug = os.environ.get('OLGA_TENANT_SLUG', 'olga')
    base_domain = os.environ.get('BASE_DOMAIN', 'yourdomain.com')
    owner_email = os.environ.get('OLGA_OWNER_EMAIL', 'info@olgaflowers.ru')
    owner_password = os.environ.get('OLGA_OWNER_PASSWORD', 'OlgaFlowers2025!')
    buyer_email = os.environ.get('OLGA_BUYER_EMAIL', 'buyer@test.com')
    buyer_password = os.environ.get('OLGA_BUYER_PASSWORD', 'Buyer123!')
    frontend_base_url = os.environ.get('FRONTEND_BASE_URL', f'https://{tenant_slug}.{base_domain}')

    print("=" * 60)
    print("СОЗДАНИЕ КУРСОВ: Ольга фарфоровые цветы")
    print("=" * 60)

    # 1. Находим тенант
    try:
        tenant = Tenant.objects.get(slug=tenant_slug)
    except Tenant.DoesNotExist:
        print(f"[ERROR] Тенант '{tenant_slug}' не найден! Сначала запустите create_olga_tenant.py")
        return

    # 2. Находим или создаём преподавателя (Ольга)
    teacher, created = CustomUser.objects.get_or_create(
        email=owner_email,
        defaults={
            'first_name': 'Ольга',
            'last_name': 'Мастер',
            'role': 'teacher',
            'is_active': True,
        }
    )
    if created:
        teacher.set_password(owner_password)
        teacher.save()
        print(f"[OK] Преподаватель создан: {teacher.email}")
    else:
        print(f"[INFO] Преподаватель уже существует: {teacher.email}")

    with transaction.atomic():
        # ============================================================
        # КУРС 1: Основы лепки фарфоровых роз
        # ============================================================
        course1, c1_created = Course.objects.get_or_create(
            tenant=tenant,
            title='Основы лепки фарфоровых роз',
            defaults={
                'teacher': teacher,
                'short_description': 'Научитесь создавать реалистичные розы из холодного фарфора. От простых бутонов до пышных соцветий.',
                'description': (
                    'В этом курсе вы освоите все базовые техники создания фарфоровых роз — '
                    'от подготовки материалов и раскатки массы до сборки многолепесткового цветка '
                    'и финишной тонировки. Каждый урок содержит подробные видеоинструкции и текстовые '
                    'материалы. По завершении курса вы сможете создавать розы, неотличимые от живых.'
                ),
                'price': 4900,
                'duration': '6 часов',
                'is_published': True,
            }
        )
        if c1_created:
            print(f"\n[OK] Курс создан: {course1.title}")
            # Уроки
            lessons1 = [
                {
                    'title': 'Введение. Материалы и инструменты',
                    'order': 1,
                    'duration': '15 мин',
                    'is_free_preview': True,
                    'content': '''<h3>Добро пожаловать на курс!</h3>
<p>Меня зовут Ольга, и я создаю фарфоровые цветы уже более 10 лет. В этом курсе я поделюсь с вами всеми секретами.</p>

<h4>Что вам понадобится:</h4>
<ul>
  <li><strong>Холодный фарфор</strong> (самозатвердевающий) — 200 г белого</li>
  <li><strong>Масляные краски</strong> для тонировки — алый, белила, зелёный</li>
  <li><strong>Клей ПВА</strong> — для укрепления лепестков</li>
  <li><strong>Проволока флористическая</strong> — №24 и №26</li>
  <li><strong>Тейп-лента</strong> зелёная</li>
</ul>

<h4>Инструменты:</h4>
<ul>
  <li>Стек с шариком (диаметр 3-5 мм)</li>
  <li>Молд лепестка розы</li>
  <li>Каттеры (вырубки) — набор из 5 размеров</li>
  <li>Коврик для раскатки (силиконовый)</li>
  <li>Кисти для тонировки — плоская и круглая</li>
</ul>

<p>Все материалы можно приобрести в специализированных магазинах для флористики или заказать онлайн.</p>''',
                },
                {
                    'title': 'Подготовка массы и окрашивание',
                    'order': 2,
                    'duration': '25 мин',
                    'content': '''<h3>Правильная подготовка — залог успеха</h3>
<p>Прежде чем приступить к лепке, необходимо правильно подготовить массу. Она должна быть пластичной, не липнуть к рукам и не трескаться при высыхании.</p>

<h4>Шаг 1: Разминание</h4>
<p>Возьмите кусочек массы размером с грецкий орех. Разомните его в руках 2-3 минуты, пока он не станет однородным и эластичным.</p>

<h4>Шаг 2: Базовое окрашивание</h4>
<p>Для розы нам нужен нежно-розовый цвет. Возьмите зубочисткой немного алой масляной краски (буквально точку) и вмешайте в массу. Разминайте до полного распределения цвета.</p>

<h4>Шаг 3: Проверка готовности</h4>
<p>Масса готова, когда она:</p>
<ul>
  <li>Не трескается при растягивании</li>
  <li>Не прилипает к пальцам</li>
  <li>Легко раскатывается в тонкий слой</li>
</ul>

<p><strong>Совет:</strong> Если масса подсохла, добавьте каплю крема для рук.</p>''',
                },
                {
                    'title': 'Раскатка и формовка лепестков',
                    'order': 3,
                    'duration': '35 мин',
                    'content': '''<h3>Создание лепестков</h3>
<p>Роза состоит из 20-30 лепестков разного размера. Начнём с маленьких внутренних и постепенно увеличим размер.</p>

<h4>Маленькие лепестки (5 штук)</h4>
<ol>
  <li>Скатайте шарик диаметром 5 мм</li>
  <li>Положите на коврик и раскатайте стеком, оставив толстый край (основание)</li>
  <li>Используя молд, придайте текстуру</li>
  <li>Закрутите края лепестка внутрь</li>
</ol>

<h4>Средние лепестки (8 штук)</h4>
<p>Аналогично, но шарик 8 мм. Эти лепестки более открытые, с лёгкими волнами по краю.</p>

<h4>Большие лепестки (8-12 штук)</h4>
<p>Шарик 10-12 мм. Края тонко раскатаны, волнистые, слегка отогнуты назад — это создаёт объём.</p>''',
                },
                {
                    'title': 'Сборка розы',
                    'order': 4,
                    'duration': '40 мин',
                    'content': '''<h3>Послойная сборка</h3>
<p>Сборка — самый ответственный этап. Здесь формируется характер вашего цветка.</p>

<h4>Сердцевина</h4>
<p>Скатайте каплевидную фигуру и насадите на проволоку №24 с крючком. Это основа розы.</p>

<h4>Первый ряд (3-5 лепестков)</h4>
<p>Оберните маленькие лепестки вокруг сердцевины, перекрывая друг друга на 1/3. Клейте на ПВА или воду.</p>

<h4>Второй ряд (5-8 лепестков)</h4>
<p>Средние лепестки — чуть свободнее, с зазором у верхнего края. Это создаёт «дыхание».</p>

<h4>Третий ряд (8-12 лепестков)</h4>
<p>Большие лепестки — максимально раскрыты. Отгибайте верхние края наружу для реалистичности.</p>

<p><strong>Важно:</strong> 每 лепесток должен быть чуть ниже предыдущего ряда.</p>''',
                },
                {
                    'title': 'Чашелистик и стебель',
                    'order': 5,
                    'duration': '20 мин',
                    'content': '''<h3>Завершающие элементы</h3>

<h4>Чашелистик</h4>
<p>Из зелёной массы вырежьте 5 заострённых листиков. Приклейте к основанию розы, слегка отогнув кончики.</p>

<h4>Стебель</h4>
<p>Обмотайте проволоку тейп-лентой, начиная от основания цветка. Натягивайте ленту для плотного прилегания.</p>

<h4>Листья</h4>
<p>Вырежьте листья каттером, нанесите текстуру молдом, закрепите на проволоке №26 и присоедините к стеблю.</p>''',
                },
                {
                    'title': 'Тонировка и финишная обработка',
                    'order': 6,
                    'duration': '30 мин',
                    'content': '''<h3>Придание реалистичности</h3>
<p>На этом этапе роза «оживает». Тонировка — это то, что отличает ремесленную работу от произведения искусства.</p>

<h4>Сухая пастель</h4>
<p>Натрите мелком сухой пастели (розовый/красный) и нанесите кистью на края лепестков. Это создаст градиент.</p>

<h4>Масляные краски</h4>
<p>Для глубоких теней используйте разбавленную масляную краску. Наносите тонким слоем у основания лепестков.</p>

<h4>Финишное покрытие</h4>
<p>После полного высыхания (24-48 часов) покройте лепестки матовым лаком для защиты.</p>

<p><strong>Поздравляю!</strong> Ваша первая фарфоровая роза готова!</p>''',
                },
            ]
            for l in lessons1:
                CourseLesson.objects.create(course=course1, **l)
            print(f"  → {len(lessons1)} уроков создано")
        else:
            print(f"[INFO] Курс уже существует: {course1.title}")

        # ============================================================
        # КУРС 2: Полевые цветы
        # ============================================================
        course2, c2_created = Course.objects.get_or_create(
            tenant=tenant,
            title='Полевые цветы из фарфора',
            defaults={
                'teacher': teacher,
                'short_description': 'Ромашки, васильки, маки — создаём букет полевых цветов с тонировкой масляными красками.',
                'description': (
                    'Курс посвящён созданию полевых цветов из холодного фарфора. Вы научитесь '
                    'лепить ромашки, васильки, маки и колокольчики, а затем собирать их в '
                    'очаровательный полевой букет. Особое внимание уделено работе с цветом '
                    'и тонировке для достижения натуралистичного эффекта.'
                ),
                'price': 3900,
                'duration': '4 часа',
                'is_published': True,
            }
        )
        if c2_created:
            print(f"\n[OK] Курс создан: {course2.title}")
            lessons2 = [
                {'title': 'Обзор полевых цветов. Особенности формы', 'order': 1, 'duration': '20 мин', 'is_free_preview': True,
                 'content': '<h3>Мир полевых цветов</h3><p>Полевые цветы отличаются простотой и нежностью. В этом уроке мы разберём особенности формы и строения каждого цветка, который будем создавать.</p>'},
                {'title': 'Ромашка — лепестки и серединка', 'order': 2, 'duration': '30 мин',
                 'content': '<h3>Создаём ромашку</h3><p>Ромашка — идеальный цветок для начинающих. Простые лепестки и яркая серединка. Учимся создавать «пушистую» серединку из окрашенной массы.</p>'},
                {'title': 'Василёк — сложные лепестки', 'order': 3, 'duration': '35 мин',
                 'content': '<h3>Василёк</h3><p>Василёк имеет характерные зубчатые лепестки. Разберём технику нарезки и формовки этих необычных элементов.</p>'},
                {'title': 'Мак — крупные лепестки и коробочка', 'order': 4, 'duration': '40 мин',
                 'content': '<h3>Красный мак</h3><p>Мак — самый яркий цветок в букете. Крупные тонкие лепестки, чёрная серединка и характерная семенная коробочка.</p>'},
                {'title': 'Колокольчик', 'order': 5, 'duration': '25 мин',
                 'content': '<h3>Нежный колокольчик</h3><p>Создаём миниатюрные колокольчики — лепим форму-воронку и формируем характерный загиб лепестков.</p>'},
                {'title': 'Сборка букета', 'order': 6, 'duration': '30 мин',
                 'content': '<h3>Собираем полевой букет</h3><p>Соединяем все цветы вместе, добавляем зелень, травинки и колоски. Обвязываем натуральным шпагатом.</p>'},
                {'title': 'Тонировка полевых цветов', 'order': 7, 'duration': '25 мин',
                 'content': '<h3>Финальная тонировка</h3><p>Добавляем нюансы цвета: приглушённые тени на ромашках, яркие акценты на маках, голубые переливы на васильках.</p>'},
            ]
            for l in lessons2:
                CourseLesson.objects.create(course=course2, **l)
            print(f"  → {len(lessons2)} уроков создано")
        else:
            print(f"[INFO] Курс уже существует: {course2.title}")

        # ============================================================
        # КУРС 3: Пионы и ранункулюсы
        # ============================================================
        course3, c3_created = Course.objects.get_or_create(
            tenant=tenant,
            title='Пионы и ранункулюсы',
            defaults={
                'teacher': teacher,
                'short_description': 'Сложные многолепестковые цветы. Техника раскатки, сборки и тонировки пастелью.',
                'description': (
                    'Продвинутый курс для тех, кто уже освоил базовые техники. Пионы и ранункулюсы — '
                    'одни из самых сложных и красивых цветов для создания из фарфора. Вы научитесь '
                    'работать с большим количеством лепестков, создавать пышные формы и добиваться '
                    'невероятной реалистичности.'
                ),
                'price': 6500,
                'duration': '8 часов',
                'is_published': True,
            }
        )
        if c3_created:
            print(f"\n[OK] Курс создан: {course3.title}")
            lessons3 = [
                {'title': 'Анатомия пиона', 'order': 1, 'duration': '20 мин', 'is_free_preview': True,
                 'content': '<h3>Строение пиона</h3><p>Пион состоит из 30-60 лепестков разного размера. Изучаем структуру и планируем работу.</p>'},
                {'title': 'Лепестки пиона — пышные и волнистые', 'order': 2, 'duration': '40 мин',
                 'content': '<h3>Лепестки</h3><p>Создаём характерные волнистые лепестки с рваными краями. Техника «мятого» лепестка.</p>'},
                {'title': 'Сборка пиона', 'order': 3, 'duration': '45 мин',
                 'content': '<h3>Многослойная сборка</h3><p>5 рядов лепестков — от плотной серединки до раскрытых наружных. Создаём пышный объём.</p>'},
                {'title': 'Тонировка пиона', 'order': 4, 'duration': '30 мин',
                 'content': '<h3>Цвет пиона</h3><p>Розовые градиенты, белые акценты, зеленоватые тени у основания — делаем пион живым.</p>'},
                {'title': 'Ранункулюс — спиральная сборка', 'order': 5, 'duration': '35 мин',
                 'content': '<h3>Ранункулюс</h3><p>Главная особенность ранункулюса — спиральное расположение лепестков. Техника аккуратной укладки.</p>'},
                {'title': 'Тонировка ранункулюса', 'order': 6, 'duration': '25 мин',
                 'content': '<h3>Нежные переходы</h3><p>Ранункулюс славится плавными переходами цвета. Работаем сухой пастелью для нежного эффекта.</p>'},
            ]
            for l in lessons3:
                CourseLesson.objects.create(course=course3, **l)
            print(f"  → {len(lessons3)} уроков создано")
        else:
            print(f"[INFO] Курс уже существует: {course3.title}")

        # ============================================================
        # КУРС 4: Свадебный букет из фарфора
        # ============================================================
        course4, c4_created = Course.objects.get_or_create(
            tenant=tenant,
            title='Свадебный букет из фарфора',
            defaults={
                'teacher': teacher,
                'short_description': 'Создание композиции для особого случая: подбор цветов, каркас, сборка.',
                'description': (
                    'Финальный курс серии — создание полноценного свадебного букета из фарфора. '
                    'Букет-дублёр, который невеста может хранить вечно. Вы научитесь подбирать цветы, '
                    'создавать каркас, собирать композицию и оформлять букет атласными лентами.'
                ),
                'price': 7900,
                'duration': '5 часов',
                'is_published': True,
            }
        )
        if c4_created:
            print(f"\n[OK] Курс создан: {course4.title}")
            lessons4 = [
                {'title': 'Планирование свадебного букета', 'order': 1, 'duration': '15 мин', 'is_free_preview': True,
                 'content': '<h3>Планирование</h3><p>Выбор цветовой палитры, формы букета (каскад, полусфера, помандер), расчёт количества цветов.</p>'},
                {'title': 'Каркас и портбукетница', 'order': 2, 'duration': '20 мин',
                 'content': '<h3>Основа букета</h3><p>Создаём проволочный каркас и подготавливаем портбукетницу — основу, в которую крепятся все цветы.</p>'},
                {'title': 'Главные цветы — розы и пионы', 'order': 3, 'duration': '45 мин',
                 'content': '<h3>Доминантные цветы</h3><p>Создаём 5-7 основных цветов букета — белые розы и нежно-розовые пионы.</p>'},
                {'title': 'Дополнительные элементы', 'order': 4, 'duration': '30 мин',
                 'content': '<h3>Акценты</h3><p>Добавляем маленькие бутоны, ягоды, листья эвкалипта, гипсофилу — детали, создающие объём.</p>'},
                {'title': 'Сборка и оформление', 'order': 5, 'duration': '40 мин',
                 'content': '<h3>Финальная сборка</h3><p>Крепим цветы в каркас, обматываем ножку атласной лентой, добавляем брошь или подвеску.</p>'},
            ]
            for l in lessons4:
                CourseLesson.objects.create(course=course4, **l)
            print(f"  → {len(lessons4)} уроков создано")
        else:
            print(f"[INFO] Курс уже существует: {course4.title}")

    # ============================================================
    # ТЕСТОВЫЙ ПОКУПАТЕЛЬ
    # ============================================================
    buyer, b_created = CustomUser.objects.get_or_create(
        email=buyer_email,
        defaults={
            'first_name': 'Мария',
            'last_name': 'Тестова',
            'role': 'student',
            'is_active': True,
        }
    )
    if b_created:
        buyer.set_password(buyer_password)
        buyer.save()
        print(f"\n[OK] Тестовый покупатель создан: {buyer.email} / {buyer_password}")
    else:
        print(f"\n[INFO] Тестовый покупатель уже есть: {buyer.email}")

    # Даём доступ к первому курсу
    access, a_created = CourseAccess.objects.get_or_create(
        user=buyer,
        course=course1,
        defaults={'access_type': 'purchased'}
    )
    if a_created:
        print(f"  → Доступ предоставлен к: {course1.title}")

    # Привязка к тенанту
    from tenants.models import TenantMembership
    TenantMembership.objects.get_or_create(
        tenant=tenant,
        user=buyer,
        defaults={'role': 'student', 'is_active': True}
    )
    TenantMembership.objects.get_or_create(
        tenant=tenant,
        user=teacher,
        defaults={'role': 'owner', 'is_active': True}
    )

    print()
    print("=" * 60)
    print("КУРСЫ ГОТОВЫ!")
    print(f"  Всего курсов: {Course.objects.filter(tenant=tenant).count()}")
    print(f"  Всего уроков: {CourseLesson.objects.filter(course__tenant=tenant).count()}")
    print()
    print("Тестовые аккаунты:")
    print(f"  Преподаватель: {owner_email} / {owner_password}")
    print(f"  Покупатель:    {buyer_email} / {buyer_password}")
    print()
    print(f"Каталог курсов: {frontend_base_url}/{tenant_slug}/courses")
    print("=" * 60)


if __name__ == '__main__':
    create_olga_courses()
else:
    create_olga_courses()
