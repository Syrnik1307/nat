"""
Примеры промптов и критериев для AI-проверки ЕГЭ/ОГЭ заданий
Используется для обучения и тестирования AI-агента
"""

# =============================================================================
# КРИТЕРИИ ФИПИ ДЛЯ РАЗНЫХ ТИПОВ ЗАДАНИЙ
# =============================================================================

EGE_CRITERIA = {
    "russian_27": {
        "name": "ЕГЭ Русский язык - Задание 27 (сочинение)",
        "max_score": 25,
        "criteria": {
            "K1": {
                "name": "Формулировка проблемы",
                "max": 1,
                "levels": [
                    {"score": 1, "desc": "Проблема сформулирована верно"},
                    {"score": 0, "desc": "Проблема не сформулирована или сформулирована неверно"}
                ]
            },
            "K2": {
                "name": "Комментарий к проблеме",
                "max": 6,
                "levels": [
                    {"score": 6, "desc": "Два примера-иллюстрации + пояснения к ним + смысловая связь + анализ связи"},
                    {"score": 5, "desc": "Два примера + пояснения + смысловая связь указана, но не проанализирована"},
                    {"score": 4, "desc": "Два примера + пояснения, но связь не указана"},
                    {"score": 3, "desc": "Два примера без пояснений / один пример с пояснением"},
                    {"score": 2, "desc": "Два примера без пояснений и связи"},
                    {"score": 1, "desc": "Один пример без пояснения"},
                    {"score": 0, "desc": "Примеров нет или не опираются на текст"}
                ]
            },
            "K3": {
                "name": "Позиция автора",
                "max": 1,
                "levels": [
                    {"score": 1, "desc": "Позиция автора сформулирована верно"},
                    {"score": 0, "desc": "Позиция не сформулирована или сформулирована неверно"}
                ]
            },
            "K4": {
                "name": "Собственная позиция",
                "max": 1,
                "levels": [
                    {"score": 1, "desc": "Отношение к позиции автора выражено и обосновано"},
                    {"score": 0, "desc": "Отношение не выражено или не обосновано"}
                ]
            },
            "K5": {
                "name": "Смысловая цельность",
                "max": 2,
                "levels": [
                    {"score": 2, "desc": "Нет логических ошибок, последовательность не нарушена"},
                    {"score": 1, "desc": "Допущена 1 логическая ошибка"},
                    {"score": 0, "desc": "Допущено 2+ логических ошибки"}
                ]
            },
            "K6": {
                "name": "Точность и выразительность речи",
                "max": 2,
                "levels": [
                    {"score": 2, "desc": "Работа точная, выразительная, разнообразная"},
                    {"score": 1, "desc": "Есть нарушения точности/выразительности"},
                    {"score": 0, "desc": "Работа бедна словами, есть речевые ошибки"}
                ]
            },
            "K7": {
                "name": "Орфография",
                "max": 3,
                "levels": [
                    {"score": 3, "desc": "0 орфографических ошибок (или 1 негрубая)"},
                    {"score": 2, "desc": "1-2 ошибки"},
                    {"score": 1, "desc": "3-4 ошибки"},
                    {"score": 0, "desc": "5+ ошибок"}
                ]
            },
            "K8": {
                "name": "Пунктуация",
                "max": 3,
                "levels": [
                    {"score": 3, "desc": "0 пунктуационных ошибок (или 1 негрубая)"},
                    {"score": 2, "desc": "1-3 ошибки"},
                    {"score": 1, "desc": "4-5 ошибок"},
                    {"score": 0, "desc": "6+ ошибок"}
                ]
            },
            "K9": {
                "name": "Грамматика",
                "max": 2,
                "levels": [
                    {"score": 2, "desc": "0 грамматических ошибок"},
                    {"score": 1, "desc": "1-2 ошибки"},
                    {"score": 0, "desc": "3+ ошибки"}
                ]
            },
            "K10": {
                "name": "Речевые нормы",
                "max": 2,
                "levels": [
                    {"score": 2, "desc": "0 речевых ошибок"},
                    {"score": 1, "desc": "1-3 ошибки"},
                    {"score": 0, "desc": "4+ ошибки"}
                ]
            },
            "K11": {
                "name": "Этические нормы",
                "max": 1,
                "levels": [
                    {"score": 1, "desc": "Этические ошибки отсутствуют"},
                    {"score": 0, "desc": "Допущены этические ошибки"}
                ]
            },
            "K12": {
                "name": "Фактологическая точность",
                "max": 1,
                "levels": [
                    {"score": 1, "desc": "Фактические ошибки отсутствуют"},
                    {"score": 0, "desc": "Допущены фактические ошибки"}
                ]
            }
        }
    },
    
    "math_profile_19": {
        "name": "ЕГЭ Математика профиль - Задание 19 (теория чисел)",
        "max_score": 4,
        "criteria": {
            "full_solution": {
                "name": "Полное решение",
                "levels": [
                    {"score": 4, "desc": "Верный ответ и полное обоснование всех пунктов"},
                    {"score": 3, "desc": "Верное решение, но имеются небольшие недочеты в обосновании"},
                    {"score": 2, "desc": "Решение содержит существенные ошибки или неполные обоснования"},
                    {"score": 1, "desc": "Рассмотрены отдельные случаи/примеры"},
                    {"score": 0, "desc": "Решение неверно, не приведено или содержит грубые ошибки"}
                ]
            }
        }
    },
    
    "social_29": {
        "name": "ЕГЭ Обществознание - Задание 29 (мини-сочинение)",
        "max_score": 6,
        "criteria": {
            "K1": {
                "name": "Раскрытие смысла высказывания",
                "max": 1,
                "levels": [
                    {"score": 1, "desc": "Смысл высказывания раскрыт ИЛИ содержание ответа даёт представление о понимании"},
                    {"score": 0, "desc": "Смысл высказывания не раскрыт"}
                ]
            },
            "K2": {
                "name": "Теоретическое содержание",
                "max": 2,
                "levels": [
                    {"score": 2, "desc": "Корректно использованы 2+ понятия/теоретические положения"},
                    {"score": 1, "desc": "Корректно использовано 1 понятие"},
                    {"score": 0, "desc": "Термины не использованы или использованы неверно"}
                ]
            },
            "K3": {
                "name": "Корректность аргументации",
                "max": 1,
                "levels": [
                    {"score": 1, "desc": "Приведены 2+ примера из разных источников"},
                    {"score": 0, "desc": "Примеры не приведены / однотипные / содержат фактические ошибки"}
                ]
            },
            "K4": {
                "name": "Качество аргументов",
                "max": 2,
                "levels": [
                    {"score": 2, "desc": "Примеры корректно иллюстрируют разные аспекты"},
                    {"score": 1, "desc": "Примеры корректны, но иллюстрируют один аспект"},
                    {"score": 0, "desc": "Примеры некорректны"}
                ]
            }
        }
    }
}

OGE_CRITERIA = {
    "russian_9_1": {
        "name": "ОГЭ Русский язык - Задание 9.1 (сочинение-рассуждение)",
        "max_score": 9,
        "criteria": {
            "C1K1": {
                "name": "Наличие обоснованного ответа",
                "max": 2,
                "levels": [
                    {"score": 2, "desc": "Тезис доказан + 2 примера-аргумента"},
                    {"score": 1, "desc": "Тезис доказан + 1 пример"},
                    {"score": 0, "desc": "Тезис не доказан"}
                ]
            },
            "C1K2": {
                "name": "Наличие примеров-аргументов",
                "max": 3,
                "levels": [
                    {"score": 3, "desc": "2 примера из текста, верно указаны номера предложений"},
                    {"score": 2, "desc": "2 примера, но есть ошибки в указании номеров"},
                    {"score": 1, "desc": "1 пример"},
                    {"score": 0, "desc": "Примеров нет"}
                ]
            },
            "C1K3": {
                "name": "Смысловая цельность",
                "max": 2,
                "levels": [
                    {"score": 2, "desc": "Нет логических ошибок"},
                    {"score": 1, "desc": "Допущена 1 логическая ошибка"},
                    {"score": 0, "desc": "2+ логических ошибки"}
                ]
            },
            "C1K4": {
                "name": "Композиция",
                "max": 2,
                "levels": [
                    {"score": 2, "desc": "Работа характеризуется композиционной стройностью"},
                    {"score": 1, "desc": "Есть нарушения композиции"},
                    {"score": 0, "desc": "Грубые нарушения композиции"}
                ]
            }
        }
    }
}

# =============================================================================
# ПРИМЕРЫ ПРОМПТОВ ДЛЯ AI
# =============================================================================

SYSTEM_PROMPT_TEMPLATE = """Ты - эксперт по проверке экзаменационных работ {exam_type} по предмету "{subject}".

Твоя задача - проверить {task_name} строго по критериям ФИПИ.

ВАЖНО:
1. Оценивай СТРОГО по критериям, не придумывай своих
2. Если в работе есть ОДНА из характеристик уровня - ставь этот балл
3. При сомнении между двумя баллами - ставь МЕНЬШИЙ (в пользу объективности)
4. Указывай КОНКРЕТНЫЕ фрагменты текста, за которые снижается балл
5. Пиши комментарии КРАТКО и ПО ДЕЛУ

КРИТЕРИИ ОЦЕНИВАНИЯ:
{criteria_json}

ФОРМАТ ОТВЕТА (строго JSON):
{{
  "scores": {{
    "K1": {{"score": 1, "reasoning": "Краткое обоснование"}},
    "K2": {{"score": 4, "reasoning": "Найдено 2 примера с пояснениями, но связь не указана"}},
    ...
  }},
  "total_score": 15,
  "summary": "Краткая итоговая характеристика работы (2-3 предложения)",
  "strengths": ["Что хорошо сделано"],
  "weaknesses": ["Где нужно улучшить"],
  "examples_of_errors": [
    {{"type": "орфографическая", "fragment": "преведенный", "correction": "приведённый"}},
    {{"type": "речевая", "fragment": "автор поднимает проблему о...", "correction": "автор поднимает проблему..."}}
  ]
}}
"""

USER_PROMPT_TEMPLATE = """ИСХОДНЫЙ ТЕКСТ (для задания):
{source_text}

ОТВЕТ УЧЕНИКА:
{student_answer}

Проверь работу по всем критериям и верни результат в формате JSON."""

# =============================================================================
# КОНКРЕТНЫЕ ПРИМЕРЫ
# =============================================================================

EXAMPLE_1_SOURCE = """
(1)Многие считают понятие чести устарелым, несовременным, в том смысле, что оно нынче не применимо — не те условия. 
(2)Для одних это связано с такими действиями, как дуэль: мол, чем иначе можно защитить свою честь от оскорблений? 
(3)Другие считают: честь сегодня заменена более высоким понятием — принципиальность. 
(4)Вместо человека чести — человек принципов..."""

EXAMPLE_1_STUDENT_ANSWER = """
Автор текста поднимает проблему о сущности чести в современном обществе. Эта проблема очень актуальна, потому что многие люди не понимают что такое честь.

В тексте автор говорит что многие считают честь устаревшим понятием (предложение 1). Это первый пример. Также автор пишет про дуэли, что раньше люди защищали честь дуэлями (предложение 2). Это второй пример, который показывает что честь связана с историей.

Автор считает что честь важна и в современности. Я согласен с автором потому что без чести нельзя жить. Честь помогает людям быть лучше и не совершать плохих поступков.

В заключении хочу сказать что проблема чести всегда будет актуальной для людей.
"""

EXAMPLE_1_EXPECTED_OUTPUT = {
    "scores": {
        "K1": {"score": 1, "reasoning": "Проблема сформулирована верно: 'проблема сущности чести в современном обществе'"},
        "K2": {"score": 2, "reasoning": "Приведены 2 примера из текста (предл. 1 и 2), НО отсутствуют пояснения к примерам и смысловая связь между ними не установлена"},
        "K3": {"score": 1, "reasoning": "Позиция автора сформулирована кратко, но верно: 'честь важна и в современности'"},
        "K4": {"score": 0, "reasoning": "Отношение к позиции автора выражено ('я согласен'), но обоснование поверхностное и общее ('без чести нельзя жить')"},
        "K5": {"score": 2, "reasoning": "Логических ошибок нет, последовательность сохранена"},
        "K6": {"score": 1, "reasoning": "Речь однообразна, есть речевые недочеты ('проблема о сущности' - правильно 'проблема сущности')"},
        "K7": {"score": 2, "reasoning": "2 орфографические ошибки: 'преведенный' → 'приведённый' (не найдена в данном тексте, но для примера)"},
        "K8": {"score": 2, "reasoning": "2 пунктуационные ошибки: отсутствует запятая перед 'что' в 'многие люди не понимают что такое честь'"},
        "K9": {"score": 2, "reasoning": "Грамматических ошибок нет"},
        "K10": {"score": 1, "reasoning": "2 речевые ошибки: 'проблема о сущности' (правильно: 'проблема сущности'), 'в заключении' (правильно: 'в заключение')"},
        "K11": {"score": 1, "reasoning": "Этических ошибок нет"},
        "K12": {"score": 1, "reasoning": "Фактических ошибок нет"}
    },
    "total_score": 16,
    "summary": "Работа показывает понимание текста, но комментарий к проблеме требует доработки. Необходимо давать пояснения к примерам и устанавливать смысловую связь между ними. Обоснование собственной позиции слишком общее.",
    "strengths": [
        "Проблема сформулирована верно",
        "Позиция автора понята",
        "Логика изложения не нарушена",
        "Отсутствуют фактические и этические ошибки"
    ],
    "weaknesses": [
        "Примеры не прокомментированы должным образом",
        "Не установлена смысловая связь между примерами",
        "Собственная позиция обоснована слабо, слишком общо",
        "Речь однообразна",
        "Есть речевые и пунктуационные ошибки"
    ],
    "examples_of_errors": [
        {"type": "речевая", "fragment": "проблема о сущности", "correction": "проблема сущности (проблема чего?)"},
        {"type": "речевая", "fragment": "в заключении", "correction": "в заключение (наречие, не склоняется)"},
        {"type": "пунктуационная", "fragment": "не понимают что такое честь", "correction": "не понимают, что такое честь"}
    ]
}

# =============================================================================
# ОПТИМИЗИРОВАННЫЙ ПРОМПТ (для экономии токенов)
# =============================================================================

OPTIMIZED_SYSTEM_PROMPT = """Эксперт ЕГЭ по русскому (сочинение). Проверь по критериям ФИПИ.

K1 (1б): формулировка проблемы
K2 (6б): 2 примера + пояснения + связь + анализ связи
K3 (1б): позиция автора
K4 (1б): своя позиция + обоснование
K5 (2б): логика (0 ош=2б, 1 ош=1б, 2+=0б)
K6 (2б): речь (точная+выразительная=2б)
K7 (3б): орфография (0-1=3б, 2=2б, 3-4=1б, 5+=0б)
K8 (3б): пунктуация (0-1=3б, 2-3=2б, 4-5=1б, 6+=0б)
K9 (2б): грамматика (0=2б, 1-2=1б, 3+=0б)
K10 (2б): речь (0=2б, 1-3=1б, 4+=0б)
K11 (1б): этика
K12 (1б): факты

JSON: {{"scores":{{"K1":{{"score":1,"reasoning":"..."}}, ...}}, "total_score":16, "summary":"...", "weaknesses":["..."]}}"""

def build_prompt(exam_type, subject, task_name, criteria, source_text, student_answer, optimized=False):
    """
    Строит промпт для AI-проверки
    
    Args:
        exam_type: "ЕГЭ" или "ОГЭ"
        subject: "Русский язык", "Математика", etc.
        task_name: "Задание 27 (сочинение)"
        criteria: словарь с критериями из EGE_CRITERIA или OGE_CRITERIA
        source_text: исходный текст задания
        student_answer: ответ ученика
        optimized: использовать сокращенный промпт (для экономии)
    
    Returns:
        tuple: (system_prompt, user_prompt)
    """
    import json
    
    if optimized:
        system_prompt = OPTIMIZED_SYSTEM_PROMPT
    else:
        criteria_json = json.dumps(criteria, ensure_ascii=False, indent=2)
        system_prompt = SYSTEM_PROMPT_TEMPLATE.format(
            exam_type=exam_type,
            subject=subject,
            task_name=task_name,
            criteria_json=criteria_json
        )
    
    user_prompt = USER_PROMPT_TEMPLATE.format(
        source_text=source_text,
        student_answer=student_answer
    )
    
    return system_prompt, user_prompt


def estimate_tokens(text):
    """Грубая оценка токенов (для русского языка ~1 токен на 3-4 символа)"""
    return len(text) // 3


if __name__ == "__main__":
    # Пример использования
    system, user = build_prompt(
        exam_type="ЕГЭ",
        subject="Русский язык",
        task_name="Задание 27 (сочинение)",
        criteria=EGE_CRITERIA["russian_27"],
        source_text=EXAMPLE_1_SOURCE,
        student_answer=EXAMPLE_1_STUDENT_ANSWER,
        optimized=True
    )
    
    print("=== SYSTEM PROMPT ===")
    print(system)
    print(f"\nТокенов: ~{estimate_tokens(system)}")
    
    print("\n=== USER PROMPT ===")
    print(user)
    print(f"\nТокенов: ~{estimate_tokens(user)}")
    
    print("\n=== ОЖИДАЕМЫЙ ОТВЕТ ===")
    import json
    print(json.dumps(EXAMPLE_1_EXPECTED_OUTPUT, ensure_ascii=False, indent=2))
