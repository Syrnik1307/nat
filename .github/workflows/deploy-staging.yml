# =============================================================
# Deploy to Staging — Автоматический деплой на stage.lectiospace.ru
# Триггер: пуш в ветку staging
# =============================================================
name: Deploy Staging

on:
  push:
    branches: [staging]

# Только один деплой одновременно
concurrency:
  group: deploy-staging
  cancel-in-progress: false

jobs:
  # Сначала проверяем код (CI)
  ci:
    uses: ./.github/workflows/ci.yml

  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: ci  # Запускается только после прохождения CI
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Подготовка SSH ---
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      # --- Деплой бэкенда ---
      - name: Deploy backend
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            set -e
            echo "=== [STAGING] Backend deploy started ==="
            
            cd /var/www/teaching_panel
            
            # Сохраняем текущий коммит для отката
            PREV_COMMIT=$(git rev-parse HEAD)
            echo "Previous commit: $PREV_COMMIT"
            
            # Pull latest code
            git fetch origin staging
            git checkout staging
            git pull origin staging --ff-only
            
            # Install dependencies
            source venv/bin/activate
            pip install -r requirements.txt --quiet
            
            # Django checks
            cd teaching_panel
            python manage.py check
            python manage.py migrate --noinput
            python manage.py collectstatic --noinput --clear 2>&1 | tail -3
            
            # Restart services
            systemctl restart teaching_panel
            sleep 3
            
            # Health check
            HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:8000/api/health/ 2>/dev/null)
            if [ "$HTTP_CODE" != "200" ]; then
              echo "ERROR: Health check failed (HTTP $HTTP_CODE)!"
              echo "Rolling back to $PREV_COMMIT..."
              cd /var/www/teaching_panel
              git checkout $PREV_COMMIT
              source venv/bin/activate
              cd teaching_panel
              pip install -r ../requirements.txt --quiet 2>/dev/null
              systemctl restart teaching_panel
              exit 1
            fi
            
            echo "=== [STAGING] Backend deploy OK ==="
          ENDSSH

      # --- Деплой фронтенда ---
      - name: Build frontend
        working-directory: frontend
        run: |
          npm ci
          CI=false PUBLIC_URL="/" npm run build

      - name: Upload frontend build
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          # Бэкап текущего билда на сервере
          ssh ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            if [ -d /var/www/teaching_panel/frontend/build ]; then
              cp -a /var/www/teaching_panel/frontend/build \
                    /var/www/teaching_panel/backups/build_staging_$(date +%Y%m%d_%H%M%S)
            fi
          ENDSSH
          
          # Загружаем новый билд
          rsync -avz --delete \
            frontend/build/ \
            ${SERVER_USER}@${SERVER_HOST}:/var/www/teaching_panel/frontend/build/

      - name: Finalize frontend deploy
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            set -e
            
            # Fix permissions
            chown -R www-data:www-data /var/www/teaching_panel/frontend/build
            chmod -R 755 /var/www/teaching_panel/frontend/build
            
            # Reload nginx
            nginx -t && systemctl reload nginx
            
            echo "=== [STAGING] Frontend deploy OK ==="
          ENDSSH

      # --- Уведомление ---
      - name: Notify Telegram
        if: always()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            EMOJI="✅"
          else
            EMOJI="❌"
          fi
          
          MSG="${EMOJI} *Staging Deploy: ${STATUS}*
          Branch: \`staging\`
          Commit: \`$(echo ${{ github.sha }} | cut -c1-7)\`
          By: ${{ github.actor }}
          [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          if [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d parse_mode="Markdown" \
              -d text="${MSG}" > /dev/null 2>&1 || true
          fi
