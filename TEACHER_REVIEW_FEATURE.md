# Функционал проверки работ учителем

## Обзор

Реализована полная система проверки домашних заданий и контрольных работ учителем с возможностью редактирования оценок и добавления комментариев.

## Изменения в Backend

### 1. Модель Answer (homework/models.py)

Добавлены новые поля:

```python
teacher_score = models.IntegerField(
    null=True, 
    blank=True, 
    help_text='Оценка учителя (переопределяет auto_score)'
)
teacher_feedback = models.TextField(
    blank=True, 
    help_text='Комментарий учителя'
)
```

### 2. Обновленная логика подсчета баллов

Метод `StudentSubmission.compute_auto_score()` теперь учитывает оценку учителя с приоритетом:

1. **teacher_score** (если установлен учителем)
2. **auto_score** (автоматическая оценка)

```python
def compute_auto_score(self):
    total = 0
    for answer in self.answers.select_related('question').all():
        # Приоритет: teacher_score > auto_score
        if answer.teacher_score is not None:
            total += answer.teacher_score
        elif answer.auto_score is not None:
            total += answer.auto_score
    self.total_score = total
    self.save(update_fields=['total_score'])
    return total
```

### 3. API Endpoint

**PATCH** `/api/submissions/{submission_id}/update_answer/`

Позволяет учителю обновить оценку и комментарий для конкретного ответа.

**Параметры запроса:**
```json
{
  "answer_id": 123,
  "teacher_score": 5,
  "teacher_feedback": "Хорошая работа, но есть небольшие ошибки"
}
```

**Валидация:**
- Доступно только учителю, создавшему задание
- `teacher_score` должен быть от 0 до максимального балла вопроса
- При установке оценки статус работы меняется на "graded"
- Автоматически пересчитывается общий балл работы

**Ответ:**
```json
{
  "id": 1,
  "homework": 5,
  "homework_title": "Past Simple Test",
  "student": 12,
  "student_name": "Иван Петров",
  "student_email": "ivan@example.com",
  "status": "graded",
  "total_score": 85,
  "answers": [
    {
      "id": 123,
      "question": 45,
      "question_text": "Напишите форму глагола...",
      "question_type": "TEXT",
      "question_points": 10,
      "text_answer": "went",
      "auto_score": null,
      "teacher_score": 8,
      "teacher_feedback": "Правильно, но не забывай про заглавную букву",
      "needs_manual_review": true
    }
  ],
  "created_at": "2025-11-26T10:30:00Z",
  "submitted_at": "2025-11-26T11:00:00Z",
  "graded_at": null
}
```

### 4. Обновленные сериализаторы

**AnswerSerializer** теперь включает:
- `teacher_score` - оценка учителя
- `teacher_feedback` - комментарий учителя
- `question_text` - текст вопроса (read-only)
- `question_type` - тип вопроса (read-only)
- `question_points` - максимальный балл (read-only)

**StudentSubmissionSerializer** теперь включает:
- `homework_title` - название задания (read-only)
- `student_name` - полное имя ученика (read-only)
- `answers` - массив ответов с полной информацией

## Изменения во Frontend

### 1. Компонент SubmissionsList

**Путь:** `/submissions`

Список всех работ учеников с возможностью фильтрации и поиска.

**Возможности:**
- Просмотр всех работ учеников
- Фильтрация по статусу (все / на проверке / проверено)
- Поиск по имени ученика или названию задания
- Отображение статистики (всего работ, на проверке, проверено)
- Переход к проверке конкретной работы

**Отображаемая информация:**
- Имя и email ученика
- Название задания
- Дата и время сдачи
- Статус (в процессе / отправлено / проверено)
- Текущий балл
- Кнопка "Проверить" или "Просмотр"

### 2. Компонент SubmissionReview

**Путь:** `/submissions/:submissionId/review`

Детальная проверка работы ученика с возможностью редактирования оценок.

**Возможности:**
- Просмотр всех ответов ученика
- Для каждого вопроса отображается:
  - Номер вопроса
  - Тип вопроса (текстовый / один вариант / несколько вариантов)
  - Текст вопроса
  - Ответ ученика
  - Автоматическая оценка (если есть)
  - Текущий балл (teacher_score или auto_score)
  - Максимальный балл

**Редактирование оценки:**
1. Нажать "Выставить оценку" или "Изменить оценку"
2. Ввести балл (валидация от 0 до максимального балла вопроса)
3. Добавить комментарий для ученика (опционально)
4. Нажать "Сохранить"

**Автоматическое обновление:**
- При сохранении оценки пересчитывается общий балл работы
- Статус меняется на "Проверено"
- Изменения применяются мгновенно

### 3. Стили

Оба компонента используют современный дизайн:
- Адаптивная верстка (mobile-first)
- Цветовая схема с индикацией статусов
- Плавные анимации и переходы
- Читаемая типографика
- Удобные формы ввода с валидацией

## Маршруты

Добавлены новые маршруты в `App.js`:

```javascript
<Route
  path="/submissions"
  element={<Protected allowRoles={['teacher']}><SubmissionsList /></Protected>}
/>
<Route
  path="/submissions/:submissionId/review"
  element={<Protected allowRoles={['teacher']}><SubmissionReview /></Protected>}
/>
```

## Миграция базы данных

Создана миграция `0002_answer_teacher_feedback_answer_teacher_score.py`

**Применение:**
```bash
python manage.py migrate
```

## Примеры использования

### 1. Учитель заходит в список работ

```
GET /api/submissions/
Authorization: Bearer {token}
```

Видит все работы учеников по своим заданиям.

### 2. Учитель открывает работу для проверки

Переход по ссылке `/submissions/123/review`

```
GET /api/submissions/123/
Authorization: Bearer {token}
```

### 3. Учитель выставляет оценку

```
PATCH /api/submissions/123/update_answer/
Authorization: Bearer {token}
Content-Type: application/json

{
  "answer_id": 456,
  "teacher_score": 7,
  "teacher_feedback": "Хороший ответ! Небольшая ошибка в грамматике."
}
```

### 4. Система автоматически обновляет итоговый балл

Пересчитывается `total_score` в модели `StudentSubmission` с учетом новой оценки.

## Безопасность

- Редактировать ответы может только учитель, создавший задание
- Проверка прав доступа на уровне API
- Валидация оценок (не может превышать максимальный балл вопроса)
- Защита маршрутов через компонент `Protected`

## Интеграция с существующей системой

Функционал полностью интегрирован с существующей системой домашних заданий:
- Использует те же модели и API
- Совместим с автоматической проверкой
- Не ломает существующий функционал
- Расширяет возможности без изменения структуры данных

## Дальнейшие улучшения

Возможные расширения функционала:

1. **Массовая проверка** - возможность выставить оценки всем ответам сразу
2. **Шаблоны комментариев** - готовые фразы для быстрой обратной связи
3. **История изменений** - отслеживание изменений оценок
4. **Уведомления** - оповещение учеников о проверке работы
5. **Экспорт оценок** - выгрузка результатов в Excel/PDF
6. **Аналитика** - статистика по времени проверки, средним баллам и т.д.

## Тестирование

Для тестирования функционала:

1. Создайте задание через конструктор
2. Войдите как ученик и выполните задание
3. Войдите как учитель
4. Перейдите в `/submissions`
5. Откройте работу ученика
6. Выставите оценки и комментарии
7. Проверьте пересчет итогового балла

## Поддержка

При возникновении проблем проверьте:
- Применена ли миграция базы данных
- Правильно ли настроены права доступа
- Корректны ли URL endpoints в API клиенте
- Установлены ли все зависимости frontend
