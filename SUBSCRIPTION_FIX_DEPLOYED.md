# Исправление проблемы с подпиской - РАЗВЁРНУТО

## Задача
При неудачной попытке оплатить вылезает модальное окно о неоплаченной подписке, даже если у пользователя уже была оплачена подписка на много времени вперед.

## Решение
Улучшена логика проверки подписки на двух уровнях:

### 1. Бэкенд (Django) - SubscriptionCreatePaymentView
**Файл**: `teaching_panel/accounts/subscriptions_views.py`

**Что изменилось**:
- Перед созданием платежа проверяем, активна ли уже текущая подписка
- Если подписка уже активна (`status='active'` И `expires_at > now`), возвращаем успех без создания платежа
- Предотвращаем ненужное изменение статуса на `pending`

**Код**:
```python
# Проверяем: если подписка уже активна и не истекла, не нужно её менять
if sub.is_active():
    # У пользователя уже есть активная подписка
    return Response({
        'subscription': SubscriptionSerializer(sub).data,
        'message': 'У вас уже есть активная подписка, продление доступно после истечения',
        'status': 'already_active'
    }, status=status.HTTP_200_OK)
```

### 2. Фронтенд - PaymentResultPage.js
**Файл**: `frontend/src/components/PaymentResultPage.js`

**Что изменилось**:
- Проверка подписки теперь учитывает обе условия:
  - `subscription.status === 'active'` (статус активен)
  - `new Date(subscription.expires_at) > new Date()` (дата истечения в будущем)
- Добавлено отдельное сообщение для истекшей подписки

**Код**:
```javascript
const isSubscriptionActive = subscription.status === 'active' && 
                             new Date(subscription.expires_at) > new Date();

if (isSubscriptionActive) {
  // Успех
  setStatus('success');
} else if (subscription.status === 'active' && new Date(subscription.expires_at) <= new Date()) {
  // Подписка была активна, но уже истекла
  setStatus('pending');
  setMessage('Подписка истекла. Продлите её чтобы продолжить пользование');
}
```

### 3. Фронтенд - SubscriptionPage.js
**Файл**: `frontend/src/components/SubscriptionPage.js`

**Что изменилось**:
- Обработка ответа `status='already_active'` от бэкенда
- Показывает информативное сообщение вместо попытки редиректа на платеж

**Код**:
```javascript
if (response.data.status === 'already_active') {
  setErrorModal({ 
    isOpen: true, 
    message: 'У вас уже есть активная подписка. Продление будет доступно после её истечения.' 
  });
  setProcessing(false);
  return;
}
```

## Результат

### До исправления
1. Пользователь с активной подпиской нажимает "Оплатить"
2. Бэкенд меняет статус на `pending`
3. Фронтенд проверяет только `status === 'active'`
4. Появляется модальное окно "Подписка не оплачена" (ошибка!)

### После исправления
1. Пользователь с активной подпиской нажимает "Оплатить"
2. Бэкенд проверяет `sub.is_active()` - возвращает успех без платежа
3. Фронтенд проверяет оба условия: статус И дату истечения
4. Показывается сообщение "У вас уже есть активная подписка"

## Развёртывание
- ✅ Коммит: e40160f
- ✅ Фронтенд собран и развёрнут на продакшене
- ✅ Django рестартован
- ✅ Nginx перезагружен
- ✅ Дата развёртывания: 24 января 2026 г.

## Тестирование
Для проверки:
1. Оплатите подписку (статус станет `active`, дата истечения будет установлена)
2. На той же странице нажмите "Оплатить" ещё раз
3. Должно появиться сообщение: "У вас уже есть активная подписка"
4. После истечения срока можно будет продлить
