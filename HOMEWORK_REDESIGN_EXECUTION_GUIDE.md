# Homework Module Redesign & QA Playbook

## 1. Текущее состояние и обнаруженные проблемы
- **Просмотр медиа на стороне ученика**: изображения и вложения в ответах не подгружаются (breakpoint: HomeworkTake). Требуется проверка CDN/статических ссылок и повторная выдача signed URL.
- **Отсутствие полноценного интерфейса проверки**: преподаватель видит только конструктор, нет списков работ «на проверке»/«проверенные» и нет формы для оценки и комментариев.
- **Новые типы вопросов**: backend уже принимает 8 типов (TEXT, SINGLE_CHOICE, MULTI_CHOICE, LISTENING, MATCHING, DRAG_DROP, FILL_BLANKS, HOTSPOT), но UI и проверка не доведены до production-ready состояния.
- **Контекст**: конструктор реализован в `frontend/src/modules/homework-analytics`, backend — `teaching_panel/homework`. Развертывание выполняется на сервере `/var/www/teaching_panel` (Gunicorn + React build под nginx).

## 2. Изменения в IA и навигации
Переименовать вкладку «Конструктор ДЗ» в **«Домашние задания»** и разбить внутри на три под-вью:
1. **Конструктор** — создание/редактирование шаблонов, назначение группам.
2. **ДЗ на проверку** — очереди для преподавателя, доступно только staff; студент видит свой статус read-only.
3. **Проверенные ДЗ** — архив, доступен обоим ролям. Студент = просмотр; преподаватель = просмотр + повторное редактирование оценки/комментария.

## 3. Функциональные требования (MVP)
### 3.1 Студент
- Исправить загрузку изображений: унифицировать `mediaBaseUrl`, добавить fallbacks, прогрессивный лоадер.
- В «Проверенные ДЗ» обеспечить read-only просмотр: блокировка инпутов, подсветка правильных/неправильных ответов, отображение комментария преподавателя и итогового балла.
- Получать уведомление (toast + Telegram webhook при наличии) при автопроверке.

### 3.2 Преподаватель
- Новый список «ДЗ на проверку»: карточка содержит ФИО студента, предмет, тему, статус, дату сдачи, баллы, кнопки «Открыть» и «Быстрая проверка».
- Форма проверки должна включать: превью вопроса, ответ ученика, авторешение (если есть), поле «Баллы» с возможностью ручной правки, поле «Комментарий преподавателя», кнопки «Отклонить» (с обязательным комментарием) и «Отправить отзыв».
- Кнопка **«Редактировать ответ ученика»** запускает повторную автопроверку: 
  1. Сохраняем изменённый ответ.
  2. Запускаем сервис `AutoCheckService` (расширить `StudentAnswer` обработку).
  3. Обновляем `points_earned` и `submission.score`.
- Комментарии и оценки должны логироваться (аудит) для последующего просмотра в «Проверенные ДЗ».

### 3.3 Комментарии к ДЗ
- Добавляем JSONField `teacher_feedback` (text + optional attachments) в `Submission`.
- REST: `PATCH /api/homework/submissions/{id}/feedback/` с полями `{score, comment, attachments}`; ответ содержит историю правок.
- UI: rich-text (минимум жирный/курсив, списки), быстрая вставка шаблонов.

## 4. Фильтры и поиск
Общие требования для учителя и ученика:
- **Фильтры**: группа, предмет, тема/тег, статус (`draft`, `assigned`, `pending_review`, `returned`, `checked`), тип проверки (manual/auto), дата сдачи (диапазон).
- **Поиск**: по названию ДЗ и ключевым словам в описании/темах.
- **Сортировки**: по дате создания, дедлайну, проценту выполнения.
Фильтры должны быть сохранены в `localStorage` (персональные пресеты).

## 5. Логика автопроверки и статусов
- Если преподаватель указывает правильные ответы, submission после отправки сразу получает `status="checked"`, балл рассчитывается автоматически, уведомление отправляется обоим сторонам.
- Если не указано достаточно данных для автопроверки, статус `pending_manual` и ДЗ попадает в очередь.
- При редактировании ответа учителем: автопроверка повторяется, логируется `override_by` и timestamp.
- В «Проверенные ДЗ» отображаем историю изменений (score timeline).

## 6. Тестирование (обязательное условие)
- **Фронтенд**: прогнать все кнопки/ссылки в трёх вкладках («Конструктор», «ДЗ на проверку», «Проверенные ДЗ») во всех ролях. Smoke: создание → назначение → прохождение → автопроверка → ручная правка → повторный просмотр студентом.
- **Бэкенд**: unit-тесты для автопроверки каждого типа вопроса + интеграционные тесты API (create, submit, auto-grade, teacher override, feedback retrieval).
- **Медиа**: отдельно протестировать загрузку/отображение изображений и аудио в student flow (desktop + mobile breakpoint).
- **Уведомления**: проверка сработавших hooks (email/Telegram, если настроено).

## 7. Рекомендации по дизайну (наш стиль)
- Карточки со скруглением 16px, drop-shadow `0 12px 30px rgba(15, 23, 42, 0.08)`.
- Primary цвет `#FF6B35`, вторичный `#3B82F6`, успех `#10B981`. Используем badge-лейблы для статусов.
- Фильтры оформить как pill-tabs (`.filter-tabs`), активное состояние — заливка primary + белый текст.
- Для списков работ использовать двухколоночную сетку >1280px, на меньших ширинах переход к stack layout.
- Комментарии преподавателя показывать в карточках с цветной полосой слева (primary) и иконкой комментария.

## 8. Ручной деплой и работа на сервере
1. **Frontend build**
   - `cd frontend && npm install && npm run build`
   - Передача: `scp -r frontend/build/* root@72.56.81.163:/var/www/teaching_panel/frontend/build/`
   - Права: `ssh root@72.56.81.163 "chmod -R 755 ... && chown -R www-data:www-data ..."`
2. **Backend**
   - `scp` нужных файлов в `/var/www/teaching_panel/teaching_panel/...`
   - `ssh` → `cd /var/www/teaching_panel/teaching_panel && source ../venv/bin/activate && python manage.py migrate homework`
   - `systemctl restart teaching_panel`
3. **Проверка**
   - `curl https://<host>/api/health/`
   - `python publish_test.py` (лежит в корне проекта) — прогоняет создание/публикацию всех типов.
4. **Rollback**
   - Хранить предыдущий build в `archive/` (команда `tar -czf teaching_panel_<ts>.tar.gz frontend build + manage code`).

## 9. AI-помощник
Для генерации вопросов/автопроверок рекомендуется **Azure OpenAI GPT-4.1 Turbo**:
- Умеет создавать мультимодальные подсказки (описание аудио/изображений) для LISTENING/HOTSPOT.
- Поддерживает длинный контекст → удобно хранить шаблоны ДЗ.
- Быстрее, чем GPT-4o Full, но даёт стабильное качество для образовательного контента.
Связку можно использовать в бэкенд сервисе SuggestionService (rate limit + кеширование).

## 10. План следующих шагов
1. Исправить загрузку медиа и внедрить универсальный `AssetPreview` компонент.
2. Внедрить новую IA (переименование + вкладки) и роутинг.
3. Реализовать интерфейсы «ДЗ на проверку» и «Проверенные ДЗ» с комментариями.
4. Расширить бекенд (feedback endpoint, override автопроверки, фильтры в API, уведомления).
5. Добавить фильтры/поиск и сохранение пресетов.
6. Покрыть unit/integration тестами + прогнать e2e (ученик ↔ преподаватель).

**Важно:** До сдачи задачи убедиться, что каждый UI контрол (кнопка, селектор, таб) работоспособен и отражает корректные данные с бэкенда. Отчёт по тестам приложить к MR/PR.
