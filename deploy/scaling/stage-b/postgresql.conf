# =============================================================================
# PostgreSQL Configuration for Stage B (8GB RAM server)
# Optimized for connection pooling via PgBouncer
# =============================================================================

# CONNECTIONS (PgBouncer handles pooling)
max_connections = 100                   # PgBouncer(50) + direct admin(10) + buffer
superuser_reserved_connections = 5

# MEMORY (25% of 8GB = 2GB for shared_buffers)
shared_buffers = 2GB
effective_cache_size = 5GB              # ~60% of RAM
work_mem = 64MB                         # More for complex queries
maintenance_work_mem = 512MB
huge_pages = try                        # Enable if available

# WRITE AHEAD LOG
wal_buffers = 64MB
checkpoint_completion_target = 0.9
max_wal_size = 4GB
min_wal_size = 1GB

# QUERY PLANNER (NVMe SSD)
random_page_cost = 1.1
effective_io_concurrency = 200
default_statistics_target = 100

# PARALLELISM (4 vCPU)
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2
parallel_tuple_cost = 0.01
parallel_setup_cost = 1000

# LOGGING
log_min_duration_statement = 500        # Log queries > 500ms
log_checkpoints = on
log_lock_waits = on
log_temp_files = 0
log_autovacuum_min_duration = 500

# AUTOVACUUM (more aggressive)
autovacuum_max_workers = 3
autovacuum_naptime = 30s
autovacuum_vacuum_threshold = 25
autovacuum_analyze_threshold = 25
autovacuum_vacuum_cost_limit = 400

# STATEMENT TIMEOUT
statement_timeout = 30000
idle_in_transaction_session_timeout = 60000
