# üìã –û—Ç—á–µ—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ - –°–µ—Å—Å–∏—è —É–ª—É—á—à–µ–Ω–∏–π Core –º–æ–¥—É–ª—è

**–î–∞—Ç–∞:** 14 –Ω–æ—è–±—Ä—è 2025  
**–ú–æ–¥—É–ª—å:** Core + Zoom + Schedule  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–ª—É—á—à–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –≤–Ω–µ–¥—Ä–µ–Ω—ã

---

## üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. ‚úÖ Cosmos DB - –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π (ETag)

**–§–∞–π–ª:** `teaching_panel/cosmos_db.py`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –§—É–Ω–∫—Ü–∏—è `upsert_item_with_etag()` –¥–ª—è —É—Å–ª–æ–≤–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º ETag
- –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (status 409/412)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# –ß—Ç–µ–Ω–∏–µ —Å ETag
item = read_item('lessons', 'lesson123', 'group456')
etag = item['_etag']

# –£—Å–ª–æ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
item['status'] = 'updated'
updated_item = upsert_item_with_etag('lessons', item, expected_etag=etag)
```

---

### 2. ‚úÖ Cosmos DB - –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–§–∞–π–ª:** `teaching_panel/cosmos_db.py`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:
  - `upsert_item`: > 200ms
  - `read_item`: > 100ms
  - `query_items`: > 300ms
- –í–∫–ª—é—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ, item_id, –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Python logging

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:**
```
WARNING: Slow Cosmos query: container=lessons, 
         query=SELECT * FROM c WHERE c.groupId=@gid, 
         result_count=150, elapsed=450.23ms
```

---

### 3. ‚úÖ Rate Limiting –Ω–∞ –∑–∞–ø—É—Å–∫ —É—Ä–æ–∫–∞

**–§–∞–π–ª:** `teaching_panel/schedule/views.py`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: **3 –ø–æ–ø—ã—Ç–∫–∏ –≤ –º–∏–Ω—É—Ç—É** –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Django cache –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP 429 –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
- TTL = 60 —Å–µ–∫—É–Ω–¥

**–ö–æ–¥:**
```python
rate_limit_key = f"start_lesson_rate_limit:{user.id}"
attempts = cache.get(rate_limit_key, 0)
if attempts >= 3:
    return Response({'detail': '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫...'}, 
                    status=429)
cache.set(rate_limit_key, attempts + 1, 60)
```

---

### 4. ‚úÖ –°–∏—Å—Ç–µ–º–∞ –∞—É–¥–∏—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π

**–§–∞–π–ª—ã:** 
- `teaching_panel/schedule/models.py` (–º–æ–¥–µ–ª—å AuditLog)
- `teaching_panel/schedule/views.py` (—Ñ—É–Ω–∫—Ü–∏—è log_audit)
- `teaching_panel/schedule/admin.py` (–∞–¥–º–∏–Ω–∫–∞ AuditLog)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**

#### –ú–æ–¥–µ–ª—å AuditLog
```python
class AuditLog(models.Model):
    user = ForeignKey(User)           # –ö—Ç–æ –≤—ã–ø–æ–ª–Ω–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ
    action = CharField()               # lesson_start, lesson_create –∏ —Ç.–¥.
    resource_type = CharField()        # Lesson, ZoomAccount
    resource_id = IntegerField()       # ID —Ä–µ—Å—É—Ä—Å–∞
    ip_address = GenericIPAddressField()
    user_agent = TextField()
    details = JSONField()              # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    timestamp = DateTimeField()        # –ö–æ–≥–¥–∞
```

#### –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
```python
log_audit(
    user=request.user,
    action='lesson_start',
    resource_type='Lesson',
    resource_id=lesson.id,
    request=request,
    details={'lesson_title': '...', 'zoom_meeting_id': '...'}
)
```

#### –ê–¥–º–∏–Ω–∫–∞
- Read-only –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø–∏—Å–µ–π –∞—É–¥–∏—Ç–∞
- –§–∏–ª—å—Ç—Ä—ã –ø–æ –¥–µ–π—Å—Ç–≤–∏—é, —Ç–∏–ø—É —Ä–µ—Å—É—Ä—Å–∞, –¥–∞—Ç–µ
- –ü–æ–∏—Å–∫ –ø–æ email, IP
- –ó–∞–ø—Ä–µ—Ç –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É
- –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ú–∏–≥—Ä–∞—Ü–∏—è:** `schedule/migrations/0007_auditlog.py` ‚úÖ

---

### 5. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∞—É–¥–∏—Ç–∞ –≤ endpoint –∑–∞–ø—É—Å–∫–∞ —É—Ä–æ–∫–∞

**–§–∞–π–ª:** `teaching_panel/schedule/views.py` ‚Üí –º–µ—Ç–æ–¥ `start_new`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–ø—É—Å–∫–µ —É—Ä–æ–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –∞—É–¥–∏—Ç–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:
- Email —É—á–∏—Ç–µ–ª—è
- –ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞ –∏ –≥—Ä—É–ø–ø—ã
- Zoom –∞–∫–∫–∞—É–Ω—Ç (email)
- Zoom meeting ID
- –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
- IP –∞–¥—Ä–µ—Å –∑–∞–ø—Ä–æ—Å–∞
- User-Agent

---

### 6. ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

**–§–∞–π–ª:** `teaching_panel/test_endpoints.py`

**–§—É–Ω–∫—Ü–∏–∏:**
- `test_register()` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `test_login()` - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ JWT
- `test_zoom_pool_stats()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—É–ª–∞
- `test_start_lesson()` - –∑–∞–ø—É—Å–∫ —É—Ä–æ–∫–∞
- `test_rate_limit()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ rate limiting
- `create_test_data()` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î

**–ó–∞–ø—É—Å–∫:**
```bash
cd teaching_panel
python test_endpoints.py
```

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
1. `cosmos_db.py` - –¥–æ–±–∞–≤–ª–µ–Ω–æ 100+ —Å—Ç—Ä–æ–∫ (ETag, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)
2. `schedule/models.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å AuditLog (~45 —Å—Ç—Ä–æ–∫)
3. `schedule/views.py` - rate limit + log_audit (~70 —Å—Ç—Ä–æ–∫)
4. `schedule/admin.py` - –∞–¥–º–∏–Ω–∫–∞ AuditLog (~35 —Å—Ç—Ä–æ–∫)
5. `test_endpoints.py` - –Ω–æ–≤—ã–π —Ñ–∞–π–ª (~250 —Å—Ç—Ä–æ–∫)

### –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ Cosmos DB
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ Cosmos –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —É—Ä–æ–∫–æ–≤
- ‚úÖ –ü–æ–ª–Ω—ã–π –∂—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ endpoints

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –°–æ–∑–¥–∞–Ω–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è
python manage.py makemigrations schedule
python manage.py migrate schedule

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# ‚úÖ schedule/migrations/0007_auditlog.py
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Django Check
```bash
python manage.py check
# ‚úÖ System check identified no issues (0 silenced).
```

### –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–µ–Ω –Ω–∞:
- ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (–Ω–µ—Ç)
- ‚úÖ –ò–º–ø–æ—Ä—Ç—ã (–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ)
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ (–ø—Ä–∏–º–µ–Ω–µ–Ω—ã)
- ‚úÖ Admin —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (—Ä–∞–±–æ—Ç–∞–µ—Ç)
