# Функционал "Быстрый урок" - Документация

## Обзор

Добавлена кнопка **"Быстрый урок"** в header главной страницы преподавателя (`TeacherHomePage`), которая позволяет мгновенно запустить Zoom-конференцию без предварительного создания урока в расписании.

## Расположение

Кнопка находится в правом верхнем углу главной страницы преподавателя рядом с кнопками "Записи" и "Сообщения".

## Возможности

### 1. Быстрый запуск урока
- Одним кликом создается экспресс-урок и запускается Zoom-конференция
- Урок автоматически привязывается к первой доступной группе преподавателя
- Если групп нет, создается группа "Без расписания"
- По умолчанию длительность урока: 60 минут (настраивается через API)

### 2. Опция записи урока
Преподаватель может выбрать, записывать ли урок:
- ✅ **Записать урок** - запись будет сохранена в Zoom и автоматически загружена в систему
- ❌ **Не записывать** - урок пройдет без записи

### 3. Настройки доступа к записи
При включении записи преподаватель сразу может выбрать, кто сможет просматривать запись:

#### Варианты доступа:
1. **Все ученики** (`all_teacher_groups`)
   - Запись доступна всем ученикам всех групп преподавателя
   - Используется по умолчанию

2. **Выбрать группы** (`custom_groups`)
   - Преподаватель выбирает конкретные группы из списка
   - В списке отображается количество учеников в каждой группе
   - Можно выбрать несколько групп

3. **Выбрать учеников** (`custom_students`)
   - Преподаватель выбирает конкретных учеников
   - Отображаются имя и фамилия каждого ученика
   - Можно выбрать несколько учеников

## Технические детали

### Frontend

**Компонент:** `QuickLessonButton.js`
- Расположение: `/frontend/src/components/QuickLessonButton.js`
- Использует модальное окно для настроек
- Валидирует выбор групп/учеников перед отправкой
- Автоматически загружает список групп и учеников из API

**Интеграция:**
```javascript
import QuickLessonButton from './QuickLessonButton';

<QuickLessonButton onSuccess={loadData} />
```

### Backend

**Endpoint:** `POST /api/schedule/lessons/quick-start/`

**Request Body:**
```json
{
  "record_lesson": true,
  "privacy_type": "groups",  // "all", "groups", "students"
  "allowed_groups": [1, 2, 3],
  "allowed_students": [10, 20, 30],
  "duration": 60,  // необязательно, по умолчанию 60 мин
  "title": "Название урока",  // необязательно
  "group_id": 5  // необязательно
}
```

**Response:**
```json
{
  "zoom_start_url": "https://zoom.us/s/...",
  "zoom_meeting_id": "123456789",
  "lesson_id": 42,
  "title": "Экспресс урок 15:39",
  "group_name": "Математика 11"
}
```

**Изменения в коде:**
1. `schedule/views.py::LessonViewSet.quick_start()` - обработка параметров записи и приватности
2. `schedule/webhooks.py::handle_recording_completed()` - применение настроек приватности при создании записи

### Поток данных

1. **Создание урока:**
   ```
   User clicks → Modal opens → Settings selected → API call → Lesson created
   ```

2. **Запуск Zoom:**
   ```
   Lesson created → Zoom account allocated → Meeting created → URL returned → Browser opens
   ```

3. **Обработка записи (если включена):**
   ```
   Meeting ends → Zoom webhook → Recording downloaded → Privacy applied → Available in "Записи"
   ```

## Валидация

### Обязательные проверки:
- ✅ Активная подписка преподавателя
- ✅ Доступные Zoom-аккаунты в пуле
- ✅ При `privacy_type=groups` - выбрана хотя бы одна группа
- ✅ При `privacy_type=students` - выбран хотя бы один ученик

### Обработка ошибок:
- **503** - Все Zoom-аккаунты заняты
- **403** - Подписка истекла
- **400** - Некорректные данные (не выбраны группы/ученики)

## Хранение настроек приватности

Настройки приватности временно хранятся в поле `Lesson.notes` в формате:
```
Создано кнопкой "Быстрый урок"
Privacy: {"privacy_type": "groups", "allowed_groups": [1, 2], "allowed_students": []}
```

При создании `LessonRecording` через webhook, эти настройки извлекаются и применяются через метод `apply_privacy()`.

## Будущие улучшения

1. **JSONField для privacy_settings**
   - Добавить отдельное поле в модель `Lesson` вместо `notes`

2. **Предпросмотр доступа**
   - Показать количество учеников, которые получат доступ

3. **Шаблоны приватности**
   - Сохранить предпочтения преподавателя для быстрого выбора

4. **Уведомления**
   - Отправлять уведомления выбранным ученикам о новой записи

## Тестирование

### Ручное тестирование:
1. Войти как преподаватель
2. Нажать "Быстрый урок" в header
3. Выбрать "Записать урок"
4. Выбрать вариант приватности
5. Нажать "Начать"
6. Проверить открытие Zoom
7. Завершить встречу
8. Проверить появление записи в разделе "Записи"
9. Проверить настройки доступа к записи

### Проверка доступа:
1. Войти как студент (из выбранной группы)
2. Перейти в "Записи"
3. Убедиться, что запись доступна
4. Войти как студент (НЕ из выбранной группы)
5. Убедиться, что запись НЕ отображается

## Безопасность

- ✅ Проверка роли (`teacher` только)
- ✅ Проверка активной подписки
- ✅ Проверка владения группами при выборе
- ✅ Проверка владения учениками при выборе
- ✅ JWT авторизация для всех запросов

## Совместимость

- React 18+
- Django 5.2+
- Django REST Framework
- Zoom API (Server-to-Server OAuth)

---

**Дата создания:** 7 декабря 2025  
**Версия:** 1.0  
**Автор:** GitHub Copilot
