# Общие locations для dev и prod

client_max_body_size 10g;
client_body_buffer_size 128k;

# Gzip сжатие
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml application/json application/javascript application/xml+rss;

# React SPA
root /usr/share/nginx/html;
index index.html;

location / {
    try_files $uri /index.html;
    
    # Кэширование статики React
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
}

# Django API
location /api/ {
    limit_req zone=api_limit burst=50 nodelay;
    limit_conn conn_limit 20;
    
    proxy_pass http://backend/api/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";
    
    proxy_connect_timeout 60s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;
    
    # Буферизация для больших ответов
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 32k;
}

# Login rate limiting (строже)
location /api/jwt/token/ {
    limit_req zone=login_limit burst=3 nodelay;
    
    proxy_pass http://backend/api/jwt/token/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location /api/jwt/register/ {
    limit_req zone=login_limit burst=3 nodelay;
    
    proxy_pass http://backend/api/jwt/register/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Schedule API
location /schedule/api/ {
    limit_req zone=api_limit burst=50 nodelay;
    
    proxy_pass http://backend/schedule/api/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";
    
    proxy_read_timeout 300s;  # Для длинных операций
}

# Webhooks (YooKassa, Zoom) - без rate limit
location /api/payments/yookassa/webhook/ {
    proxy_pass http://backend/api/payments/yookassa/webhook/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Static files
location /static/ {
    alias /var/www/static/;
    expires 30d;
    add_header Cache-Control "public";
    access_log off;
}

# Media files
location /media/ {
    alias /var/www/media/;
    expires 7d;
    add_header Cache-Control "public";
}

# Health check для load balancer
location /health {
    access_log off;
    return 200 "ok";
    add_header Content-Type text/plain;
}
