# Инструкция по тестированию функционала "Быстрый урок"

## Что было добавлено

✅ Новая кнопка **"Быстрый урок"** в header главной страницы преподавателя  
✅ Модальное окно с настройками записи и приватности  
✅ Backend поддержка параметров `record_lesson` и `privacy_type`  
✅ Автоматическое применение настроек доступа к записям  

## Запуск для тестирования

### 1. Запустить Backend (Django)

```powershell
cd teaching_panel
..\venv\Scripts\Activate.ps1
python manage.py runserver
```

**Проверка:** Сервер должен быть доступен на `http://127.0.0.1:8000`

### 2. Запустить Frontend (React)

```powershell
cd frontend
npm start
```

**Проверка:** Приложение откроется на `http://localhost:3000`

## Пошаговое тестирование

### Шаг 1: Проверка кнопки

1. Войдите как преподаватель
2. Перейдите на главную страницу (`/teacher`)
3. Найдите кнопку **"Быстрый урок"** в правом верхнем углу (рядом с "Записи" и "Сообщения")

**Ожидаемый результат:** Кнопка отображается, имеет темно-синий градиент

### Шаг 2: Открытие модального окна

1. Нажмите на кнопку **"Быстрый урок"**

**Ожидаемый результат:** 
- Открывается модальное окно
- Есть чекбокс "Записать урок"
- Есть кнопки "Начать" и "Отмена"

### Шаг 3: Запуск без записи

1. НЕ ставьте галочку "Записать урок"
2. Нажмите **"Начать"**

**Ожидаемый результат:**
- Открывается новая вкладка с Zoom-конференцией
- Модальное окно закрывается
- Урок появляется в расписании на сегодня

### Шаг 4: Запуск с записью (доступ всем)

1. Нажмите кнопку **"Быстрый урок"** снова
2. Поставьте галочку **"Записать урок"**
3. Появляется раздел "Кому будет доступна запись?"
4. Выберите **"Все ученики"** (должно быть выбрано по умолчанию)
5. Нажмите **"Начать"**

**Ожидаемый результат:**
- Открывается Zoom с включенной записью
- После завершения встречи запись появится в разделе "Записи"
- Запись доступна всем ученикам преподавателя

### Шаг 5: Запуск с выбором групп

1. Нажмите **"Быстрый урок"**
2. Поставьте галочку **"Записать урок"**
3. Выберите **"Выбрать группы"**
4. Должен появиться список групп с чекбоксами
5. Выберите 1-2 группы
6. Нажмите **"Начать"**

**Ожидаемый результат:**
- Zoom открывается с записью
- После завершения запись доступна только выбранным группам

**Проверка валидации:**
- Попробуйте нажать "Начать" без выбора групп
- Должна появиться ошибка: "Выберите хотя бы одну группу"

### Шаг 6: Запуск с выбором учеников

1. Нажмите **"Быстрый урок"**
2. Поставьте галочку **"Записать урок"**
3. Выберите **"Выбрать учеников"**
4. Должен появиться список учеников
5. Выберите 1-2 учеников
6. Нажмите **"Начать"**

**Ожидаемый результат:**
- Zoom открывается с записью
- После завершения запись доступна только выбранным ученикам

### Шаг 7: Проверка доступа к записи

1. Завершите Zoom-встречу
2. Дождитесь окончания обработки записи (~2-5 минут)
3. Перейдите в раздел **"Записи"**
4. Найдите созданную запись

**Для преподавателя:**
- Запись отображается
- Можно просмотреть
- Отображаются настройки доступа

**Для ученика (из выбранной группы):**
1. Войдите как студент
2. Перейдите в "Записи"
3. Запись должна отображаться

**Для ученика (НЕ из выбранной группы):**
1. Войдите как другой студент
2. Перейдите в "Записи"
3. Запись НЕ должна отображаться

## Проверка ошибок

### Тест 1: Нет доступных Zoom аккаунтов
- Занять все Zoom аккаунты другими встречами
- Попробовать создать быстрый урок
- **Ожидается:** Ошибка "Все Zoom аккаунты заняты. Попробуйте позже."

### Тест 2: Истекшая подписка
- Установить `subscription.expires_at` в прошлое
- Попробовать создать быстрый урок
- **Ожидается:** Ошибка 403 "Подписка истекла"

### Тест 3: Попытка доступа не преподавателем
- Войти как студент
- Перейти на главную страницу
- **Ожидается:** Кнопка "Быстрый урок" не отображается

## Логи для отладки

### Frontend (Browser Console)
```javascript
// Открыть DevTools (F12)
// Проверить вкладку Console на наличие ошибок
```

### Backend (Terminal)
```python
# Смотреть логи Django
# При создании урока должны появиться:
[INFO] Creating quick lesson for teacher <email>
[INFO] Allocating Zoom account from pool
[INFO] Starting Zoom meeting <meeting_id>
```

### Zoom Webhook
```python
# После завершения встречи:
[INFO] Received Zoom webhook: recording.completed
[INFO] Processing recording for lesson <lesson_id>
[INFO] Applying privacy settings: <privacy_type>
```

## Известные особенности

1. **Обработка записи занимает время**
   - Zoom обрабатывает запись 2-5 минут после завершения встречи
   - Затем webhook отправляет данные в систему
   - Потом система скачивает и загружает в Google Drive
   - Полный цикл: 5-10 минут

2. **Настройки приватности хранятся в notes**
   - Временное решение, пока не добавлено отдельное JSONField
   - Не редактировать поле `notes` вручную для уроков с приватностью

3. **Автоматическая группа**
   - Если у преподавателя нет групп, создается группа "Без расписания"
   - Эта группа используется для всех быстрых уроков

## Часто встречающиеся проблемы

### Проблема: Модальное окно не открывается
**Решение:**
- Проверить Browser Console на ошибки
- Убедиться что QuickLessonButton импортирован в TeacherHomePage
- Перезагрузить страницу

### Проблема: Кнопка "Начать" не работает
**Решение:**
- Проверить Django logs
- Убедиться что backend запущен
- Проверить токен авторизации в localStorage

### Проблема: Zoom не открывается
**Решение:**
- Проверить response в Network tab
- Убедиться что `zoom_start_url` возвращается
- Проверить блокировку popup окон в браузере

### Проблема: Запись не появляется
**Решение:**
- Подождать 5-10 минут
- Проверить Zoom webhook logs
- Убедиться что webhook настроен на Zoom

## Файлы для проверки

### Frontend:
- `frontend/src/components/QuickLessonButton.js` - новый компонент
- `frontend/src/components/TeacherHomePage.js` - интеграция кнопки

### Backend:
- `teaching_panel/schedule/views.py` - метод `quick_start()`
- `teaching_panel/schedule/webhooks.py` - обработка `recording.completed`

### API endpoint:
- `POST /api/schedule/lessons/quick-start/`

## Контрольный чеклист

- [ ] Кнопка отображается на главной странице
- [ ] Модальное окно открывается при клике
- [ ] Можно запустить урок без записи
- [ ] Можно запустить урок с записью
- [ ] Настройки приватности работают (все ученики)
- [ ] Настройки приватности работают (выбранные группы)
- [ ] Настройки приватности работают (выбранные ученики)
- [ ] Валидация срабатывает при пустом выборе
- [ ] Zoom открывается корректно
- [ ] Запись появляется в разделе "Записи"
- [ ] Доступ к записи ограничен согласно настройкам
- [ ] Нет ошибок в Browser Console
- [ ] Нет ошибок в Django logs

---

**Документация:** См. `QUICK_LESSON_FEATURE_GUIDE.md`  
**Дата:** 7 декабря 2025
