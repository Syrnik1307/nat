{
	"version": "2.0.0",
	"tasks": [
		{
			"label": "prod: auth+join smoke",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"ssh tp \"cd /var/www/teaching_panel/teaching_panel && source ../venv/bin/activate && python -c 'from django.contrib.auth import get_user_model; from rest_framework_simplejwt.tokens import RefreshToken; import urllib.request,urllib.parse,urllib.error,json,datetime; email=\"syrnik1307@gmail.com\"; User=get_user_model(); u=User.objects.get(email=email); tok=str(RefreshToken.for_user(u).access_token); \n\ndef call(method,url,data=None):\n  req=urllib.request.Request(url,data=data,headers={\"Authorization\":\"Bearer \"+tok},method=method);\n  try:\n    with urllib.request.urlopen(req,timeout=20) as resp:\n      return resp.status, resp.read().decode(\"utf-8\",\"ignore\")\n  except urllib.error.HTTPError as e:\n    return e.code, e.read().decode(\"utf-8\",\"ignore\")\n\ncode,body=call(\"GET\",\"https://lectio.space/api/me/\"); print(\"ME_STATUS=\",code); \ntry:\n  d=json.loads(body) if body else {};\n  print(\"ME_EMAIL=\",d.get(\"email\")); print(\"ME_ROLE=\",d.get(\"role\"));\nexcept Exception:\n  print(\"ME_BODY_PARSE_ERROR\");\n\n# lessons today\nnow=datetime.datetime.now(); day=now.strftime(\"%Y-%m-%d\"); start=day+\"T00:00:00\"; end=day+\"T23:59:59\"; qs=urllib.parse.urlencode({\"start\":start,\"end\":end,\"include_recurring\":\"true\"});\ncode,body=call(\"GET\",\"https://lectio.space/api/schedule/lessons/?\"+qs); print(\"LESSONS_STATUS=\",code);\nitems=[];\ntry:\n  data=json.loads(body) if body else {};\n  items=data.get(\"results\",data if isinstance(data,list) else []);\nexcept Exception:\n  items=[];\n\ndef parse_dt(s):\n  if not s: return None\n  try: return datetime.datetime.fromisoformat(s.replace(\"Z\",\"+00:00\"))\n  except Exception: return None\n\nreal=[];\nfor it in items:\n  lid=it.get(\"id\"); dt=parse_dt(it.get(\"start_time\"));\n  if isinstance(lid,int) and dt is not None: real.append((dt,lid));\nreal.sort(key=lambda x:x[0]);\nprint(\"REAL_NUMERIC=\",len(real));\n\n# try join\nfound=False;\nfor dt,lid in real[:8]:\n  jcode,jbody=call(\"POST\",f\"https://lectio.space/api/schedule/lessons/{lid}/join/\",data=b\"{}\");\n  msg=\"\";\n  try:\n    jd=json.loads(jbody) if jbody else {};\n    msg=jd.get(\"detail\",\"\");\n    if jcode==200: print(\"JOIN_OK lesson=\",lid,\"has_url=\",bool(jd.get(\"zoom_join_url\"))); found=True; break\n  except Exception:\n    pass\n  print(\"JOIN_TRY lesson=\",lid,\"code=\",jcode,(\"detail=\"+msg) if msg else \"\");\nif not found: print(\"JOIN_RESULT=NO_200_FOUND\");'\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: auth+join smoke v2",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"prod_join_smoke.ps1"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: ssh check",
			"type": "shell",
			"command": "powershell",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-Command",
				"ssh tp 'echo SSH_OK'"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: venv python -V",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"ssh tp \"cd /var/www/teaching_panel/teaching_panel && source ../venv/bin/activate && python -V\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: run join smoke script",
			"type": "shell",
			"command": "powershell",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"prod_join_smoke.ps1"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: run join smoke script v2",
			"type": "shell",
			"command": "powershell",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"prod_join_smoke.ps1"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: run join smoke to file",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"del /q prod_join_smoke_output.txt 2>nul & powershell.exe -NoProfile -ExecutionPolicy Bypass -File prod_join_smoke.ps1 > prod_join_smoke_output.txt 2>&1 & exit /b 0"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: write file check",
			"type": "shell",
			"command": "powershell.exe",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-Command",
				"Write-Output hi | Out-File -FilePath prod_join_smoke_output.txt -Encoding utf8; exit 0"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "frontend: build",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"cd /d c:\\Users\\User\\Desktop\\nat\\frontend && npm run build"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "git: status",
			"type": "shell",
			"command": "git",
			"args": [
				"status",
				"--porcelain"
			],
			"isBackground": false,
			"problemMatcher": [],
			"group": "build"
		},
		{
			"label": "git: status (short)",
			"type": "shell",
			"command": "git",
			"args": [
				"status",
				"-sb"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "git: status (porcelain)",
			"type": "shell",
			"command": "git",
			"args": [
				"status",
				"--porcelain=v1",
				"-uall"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "git: diff names",
			"type": "shell",
			"command": "git",
			"args": [
				"diff",
				"--name-only"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "git: is .gitignore tracked",
			"type": "shell",
			"command": "git",
			"args": [
				"ls-files",
				".gitignore"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "git: diff cached names",
			"type": "shell",
			"command": "git",
			"args": [
				"diff",
				"--cached",
				"--name-only"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "git: diff .gitignore",
			"type": "shell",
			"command": "git",
			"args": [
				"diff",
				"--",
				".gitignore"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "git: add (student card + gitignore)",
			"type": "shell",
			"command": "git",
			"args": [
				"add",
				"frontend/src/components/StudentHomePage.js",
				"frontend/src/styles/StudentHome.css",
				".gitignore"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "git: commit",
			"type": "shell",
			"command": "git",
			"args": [
				"commit",
				"-m",
				"student: remove broken course button"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "git: push",
			"type": "shell",
			"command": "git",
			"args": [
				"push"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "deploy: prod (server build frontend)",
			"type": "shell",
			"command": ".\\deploy_to_prod.ps1",
			"args": [
				"-SSHAlias",
				"tp",
				"-GitBranch",
				"main"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: check revision",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel && git rev-parse --short HEAD"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: force git pull + rev",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel && sudo -u www-data git pull origin main && git rev-parse --short HEAD"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "deploy: prod (skip migrations)",
			"type": "shell",
			"command": ".\\deploy_to_prod.ps1",
			"args": [
				"-SSHAlias",
				"tp",
				"-GitBranch",
				"main",
				"-SkipMigrations"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: check frontend build exists",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"ls -la /var/www/teaching_panel/frontend/build | head -n 20"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: services active",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"sudo systemctl is-active teaching_panel nginx"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: verify button removed in build",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"grep -R \"Перейти к курсу\" -n /var/www/teaching_panel/frontend/build || true"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: students smoke",
			"type": "shell",
			"command": "powershell",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"prod_students_smoke.ps1"
			],
			"isBackground": false
		},
		{
			"label": "prod: students smoke (pwsh)",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"prod_students_smoke.ps1"
			],
			"isBackground": false
		},
		{
			"label": "prod: homework smoke (pwsh)",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"prod_homework_smoke.ps1"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: students smoke (pwsh)",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"prod_students_smoke.ps1"
			],
			"isBackground": false
		},
		{
			"label": "prod: create test teacher",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"ssh tp \"cd /var/www/teaching_panel/teaching_panel && source ../venv/bin/activate && python -c 'from django.contrib.auth import get_user_model, authenticate; from django.utils import timezone; from accounts.models import Subscription; import secrets,string; User=get_user_model(); now=timezone.now(); alphabet=string.ascii_letters+string.digits; pw=\\\"\\\".join(secrets.choice(alphabet) for _ in range(16)); suffix=secrets.token_hex(3); day=now.strftime(\\\"%Y%m%d\\\"); email=\\\"test_teacher_{}_{}@test.local\\\".format(day,suffix); user=User.objects.create_user(email=email,password=pw,role=\\\"teacher\\\",first_name=\\\"Тест\\\",last_name=\\\"Учитель\\\"); sub=Subscription.objects.create(user=user,plan=Subscription.PLAN_MONTHLY,status=Subscription.STATUS_ACTIVE,expires_at=now+timezone.timedelta(days=30),auto_renew=False); ok=authenticate(username=email,password=pw) is not None; print(\\\"CREATED_TEACHER_EMAIL=\\\",email); print(\\\"CREATED_TEACHER_PASSWORD=\\\",pw); print(\\\"SUB_STATUS=\\\",sub.status); print(\\\"SUB_EXPIRES_AT=\\\",sub.expires_at.isoformat()); print(\\\"AUTH_OK=\\\",int(ok));'\""
			],
			"isBackground": false,
			"problemMatcher": [],
			"group": "build"
		},
		{
			"label": "prod: privacy smoke (pwsh)",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"prod_privacy_smoke.ps1"
			],
			"isBackground": false
		},
		{
			"label": "prod: cleanup files",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel/teaching_panel && source ../venv/bin/activate && python manage.py cleanup_local_homework_files"
			],
			"isBackground": false
		},
		{
			"label": "prod: cleanup files v2",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel/teaching_panel && source ../venv/bin/activate && python manage.py cleanup_local_homework_files > /tmp/cleanup.log 2>&1 && cat /tmp/cleanup.log"
			],
			"isBackground": false
		},
		{
			"label": "prod: read cleanup log",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cat /tmp/cleanup.log"
			],
			"isBackground": false
		},
		{
			"label": "prod: tail cleanup log",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"tail -50 /tmp/cleanup.log"
			],
			"isBackground": false
		},
		{
			"label": "pwsh force reset",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"check_teachers.ps1"
			]
		},
		{
			"label": "pwsh sync after fix",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"check_teachers.ps1"
			]
		},
		{
			"label": "pwsh grep lessonrecording",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"check_teachers.ps1"
			]
		},
		{
			"label": "pwsh fix on server",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"check_teachers.ps1"
			]
		},
		{
			"label": "pwsh sync recs final",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"check_teachers.ps1"
			]
		},
		{
			"label": "pwsh deploy migration",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"check_teachers.ps1"
			]
		},
		{
			"label": "pwsh show migrations",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"check_teachers.ps1"
			]
		},
		{
			"label": "pwsh check 0029",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"check_teachers.ps1"
			]
		},
		{
			"label": "pwsh git log",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"check_teachers.ps1"
			]
		},
		{
			"label": "pwsh show commit",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"check_teachers.ps1"
			]
		},
		{
			"label": "pwsh check nested",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"check_teachers.ps1"
			]
		},
		{
			"label": "pwsh find 0029",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"check_teachers.ps1"
			]
		},
		{
			"label": "pwsh copy and migrate",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"check_teachers.ps1"
			]
		},
		{
			"label": "pwsh restart and sync",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"check_teachers.ps1"
			]
		},
		{
			"label": "tmp-ssh-query-prototype",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"bash -lc \"cd /var/www/teaching_panel/teaching_panel && ../venv/bin/python - <<'PY'\nfrom schedule.models import LessonRecording\nqs=LessonRecording.objects.filter(title__icontains='прототип')\nprint('count', qs.count())\nfor r in qs:\n    print(r.id, r.title, r.created_at, r.status, r.duration, r.file_size, r.gdrive_file_id, r.zoom_recording_id, r.archive_key, r.updated_at)\nPY\n\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-ssh-query-prototype-oneliner",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel/teaching_panel && ../venv/bin/python -c \"from schedule.models import LessonRecording; qs=LessonRecording.objects.filter(title__icontains='прототип'); print('count', qs.count()); [print(r.id, r.title, r.created_at, r.status, r.duration, r.file_size, r.gdrive_file_id, r.zoom_recording_id, r.archive_key, r.updated_at) for r in qs]\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-ssh-check",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel/teaching_panel && set -x; ../venv/bin/python -c \"print('ok')\"; echo RC:$?"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-ssh-query-prototype-heredoc2",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel/teaching_panel && ../venv/bin/python - <<PY\nfrom schedule.models import LessonRecording\nqs=LessonRecording.objects.filter(title__icontains=\"прототип\")\nprint(\"count\", qs.count())\nfor r in qs:\n    print(r.id, r.title, r.created_at, r.status, r.duration, r.file_size, r.gdrive_file_id, r.zoom_recording_id, r.archive_key, r.updated_at)\nPY"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-ssh-query-pwsh-controlled",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoLogo",
				"-NoProfile",
				"-Command",
				"'ssh tp \"cd /var/www/teaching_panel/teaching_panel && ../venv/bin/python -c ''from schedule.models import LessonRecording; qs=LessonRecording.objects.filter(title__icontains=\"прототип\"); print(\"count\", qs.count()); [print(r.id, r.title, r.created_at, r.status, r.duration, r.file_size, r.gdrive_file_id, r.zoom_recording_id, r.archive_key, r.updated_at) for r in qs]''\"'"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-ssh-query-pwsh2",
			"type": "shell",
			"command": "pwsh",
			"args": [
				"-NoLogo",
				"-NoProfile",
				"-Command",
				"ssh tp \"cd /var/www/teaching_panel/teaching_panel && ../venv/bin/python -c 'from schedule.models import LessonRecording; qs=LessonRecording.objects.filter(title__icontains=\\\"прототип\\\"); print(\\\"count\\\", qs.count()); [print(r.id, r.title, r.created_at, r.status, r.duration, r.file_size, r.gdrive_file_id, r.zoom_recording_id, r.archive_key, r.updated_at) for r in qs]'\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-cmd-ssh-echo",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"ssh tp \"echo hello\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-cmd-ssh-query",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"ssh tp \"cd /var/www/teaching_panel/teaching_panel && ../venv/bin/python -c \\\"from schedule.models import LessonRecording; qs=LessonRecording.objects.filter(title__icontains='прототип'); print('count', qs.count()); [print(r.id, r.title, r.created_at, r.status, r.duration, r.file_size, r.gdrive_file_id, r.zoom_recording_id, r.archive_key, r.updated_at) for r in qs]\\\"\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-cmd-ssh-pipe",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"type temp_query.py | ssh tp \"cd /var/www/teaching_panel/teaching_panel && ../venv/bin/python -\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-cmd-ssh-dir",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"ssh tp \"pwd\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-cmd-ssh-ls",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"ssh tp \"ls /var/www/teaching_panel/teaching_panel\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-cmd-ssh-ls2",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"ssh tp \"ls /var/www\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-cmd-ssh-ls3",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"ssh tp \"ls /var/www/teaching_panel\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-cmd-ssh-find-manage",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"ssh tp \"find /var/www -maxdepth 4 -name manage.py\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-cmd-ssh-manage",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"ssh tp \"cd /var/www/teaching_panel/teaching_panel && ../venv/bin/python manage.py shell -c \\\"from schedule.models import LessonRecording; qs=LessonRecording.objects.filter(title__icontains='прототип'); print('count', qs.count()); [print(r.id, r.title, r.created_at, r.status, r.duration, r.file_size, r.gdrive_file_id, r.zoom_recording_id, r.archive_key, r.updated_at) for r in qs]\\\"\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-cmd-ssh-manage2",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"ssh tp \"cd /var/www/teaching_panel/teaching_panel && ../venv/bin/python manage.py shell -c 'from schedule.models import LessonRecording; qs=LessonRecording.objects.filter(title__icontains=\\\"прототип\\\"); print(\\\"count\\\", qs.count()); [print(r.id, r.title, r.created_at, r.status, r.duration, r.file_size, r.gdrive_file_id, r.zoom_recording_id, r.archive_key, r.updated_at) for r in qs]'\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-cmd-ssh-script",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"type remotecmd.sh | ssh tp \"bash -s\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-cmd-ssh-grep",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"ssh tp \"grep -n 'recording 13' /var/www/teaching_panel/zoom_logs.txt\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-cmd-ssh-grep2",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"ssh tp \"grep -n \\\"recording 13\\\" /var/www/teaching_panel/zoom_logs.txt\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-cmd-ssh-grep-script",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"type remotegrep.sh | ssh tp \"bash -s\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "tmp-cmd-ssh-tail",
			"type": "shell",
			"command": "cmd",
			"args": [
				"/c",
				"type remotetail.sh | ssh tp \"bash -s\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "check storage URL",
			"type": "shell",
			"command": "ssh tp 'bash /tmp/check_build_url.sh'",
			"isBackground": false
		},
		{
			"label": "check storage URL v2",
			"type": "shell",
			"command": "cmd /c \"scp check_build_url.sh tp:/tmp/ && ssh tp bash /tmp/check_build_url.sh\"",
			"isBackground": false
		},
		{
			"label": "check build date",
			"type": "shell",
			"command": "ssh tp \"ls -la /var/www/teaching_panel/frontend/build/static/js/182*.js 2>&1\"",
			"isBackground": false
		},
		{
			"label": "rebuild frontend",
			"type": "shell",
			"command": "cd frontend && npm run build && echo BUILD DONE",
			"isBackground": false
		},
		{
			"label": "check URL in build",
			"type": "shell",
			"command": "findstr /C:\"storage/gdrive-stats/all\" frontend\\build\\static\\js\\182*.js",
			"isBackground": false
		},
		{
			"label": "deploy to prod",
			"type": "shell",
			"command": "powershell -File deploy_to_prod.ps1 -SSHAlias tp -GitBranch main -SkipMigrations",
			"isBackground": false
		},
		{
			"label": "verify deploy",
			"type": "shell",
			"command": "ssh tp \"ls -la /var/www/teaching_panel/frontend/build/index.html && systemctl is-active teaching_panel\"",
			"isBackground": false
		},
		{
			"label": "frontend-deploy",
			"type": "shell",
			"command": "scp -r frontend/build tp:/var/www/teaching_panel/frontend/build_new && ssh tp 'cd /var/www/teaching_panel/frontend && rm -rf build_old && mv build build_old && mv build_new build && sudo systemctl restart teaching_panel && echo DEPLOY_SUCCESS && ls -la build/index.html'",
			"isBackground": false
		},
		{
			"label": "frontend-deploy-step1",
			"type": "shell",
			"command": "ssh tp 'rm -rf /var/www/teaching_panel/frontend/build_new' && scp -r frontend/build tp:/var/www/teaching_panel/frontend/build_new && echo SCP_DONE",
			"isBackground": false
		},
		{
			"label": "frontend-deploy-step2",
			"type": "shell",
			"command": "ssh tp 'cd /var/www/teaching_panel/frontend && rm -rf build_old && mv build build_old && mv build_new build && sudo systemctl restart teaching_panel && echo DEPLOY_COMPLETE && ls -la build/index.html && systemctl is-active teaching_panel'",
			"isBackground": false
		},
		{
			"label": "test storage api final",
			"type": "shell",
			"command": "scp test_storage_v4.sh tp:/tmp/ && ssh tp \"bash /tmp/test_storage_v4.sh\"",
			"isBackground": false
		},
		{
			"label": "build frontend",
			"type": "shell",
			"command": "cd frontend && npm run build",
			"isBackground": false
		},
		{
			"label": "verify deploy",
			"type": "shell",
			"command": "ssh tp \"systemctl is-active teaching_panel && cd /var/www/teaching_panel && git log --oneline -1 && ls -la frontend/build/index.html\"",
			"isBackground": false
		},
		{
			"label": "fix-production",
			"type": "shell",
			"command": "scp scripts/fix_hosts_backup.sh tp:/tmp/ && ssh tp 'sudo bash /tmp/fix_hosts_backup.sh'",
			"isBackground": false
		},
		{
			"label": "check-backups",
			"type": "shell",
			"command": "ssh tp \"ls -la /var/backups/teaching_panel/*.gz 2>/dev/null | tail -5 && echo && grep ALLOWED_HOSTS /var/www/teaching_panel/teaching_panel/.env\"",
			"isBackground": false
		},
		{
			"label": "show-backups",
			"type": "shell",
			"command": "ssh tp \"echo BACKUPS: && ls -la /var/backups/teaching_panel/ | tail -6\"",
			"isBackground": false
		},
		{
			"label": "list-backups",
			"type": "shell",
			"command": "ssh tp ls -la /var/backups/teaching_panel/",
			"isBackground": false
		},
		{
			"label": "status-all",
			"type": "shell",
			"command": "ssh tp \"echo === STATUS === && systemctl is-active teaching_panel nginx fail2ban && echo && echo === UFW === && sudo ufw status | head -10 && echo && echo === RATE LIMIT === && grep -c limit_req /etc/nginx/nginx.conf && echo zones configured\"",
			"isBackground": false
		},
		{
			"label": "services-status",
			"type": "shell",
			"command": "ssh tp systemctl is-active teaching_panel nginx fail2ban",
			"isBackground": false
		},
		{
			"label": "prod: push monitoring telegram config",
			"type": "shell",
			"command": "powershell",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"scripts\\push_monitoring_telegram.ps1"
			],
			"isBackground": false
		},
		{
			"label": "local: run safe checks",
			"type": "shell",
			"command": "powershell",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"scripts\\run_checks.ps1"
			],
			"isBackground": false
		},
		{
			"label": "local: enable git hooks",
			"type": "shell",
			"command": "powershell",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"scripts\\setup_git_hooks.ps1"
			],
			"isBackground": false
		},
		{
			"label": "prod: setup errors bot",
			"type": "shell",
			"command": "powershell",
			"args": [
				"-NoProfile",
				"-ExecutionPolicy",
				"Bypass",
				"-File",
				"scripts\\push_errors_bot_config.ps1"
			],
			"isBackground": false
		},
		{
			"label": "prod: sync monitoring scripts",
			"type": "shell",
			"command": "ssh tp 'cd /var/www/teaching_panel && git pull origin main && sudo cp scripts/monitoring/*.sh /opt/lectio-monitor/ && sudo chmod +x /opt/lectio-monitor/*.sh && echo SYNC_OK'",
			"isBackground": false
		},
		{
			"label": "check recording 14",
			"type": "shell",
			"command": "ssh tp \"cd /var/www/teaching_panel && source venv/bin/activate && python manage.py shell --command='from schedule.models import LessonRecording; r=LessonRecording.objects.get(id=14); print(r.play_url); print(r.gdrive_file_id)'\""
		},
		{
			"label": "prod: sync+build+restart (stream fix)",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel && sudo git fetch origin main && sudo git reset --hard origin/main && cd frontend && npm run build && sudo systemctl restart teaching_panel && echo DEPLOY_OK && sudo systemctl is-active teaching_panel"
			],
			"isBackground": false,
			"problemMatcher": [],
			"group": "build"
		},
		{
			"label": "prod: test recording stream (range)",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel/teaching_panel && source ../venv/bin/activate && TOKEN=$(python manage.py shell -c \"from django.contrib.auth import get_user_model; from rest_framework_simplejwt.tokens import AccessToken; User=get_user_model(); u=User.objects.get(id=4); print(str(AccessToken.for_user(u)))\") && echo TOKEN_LEN:${#TOKEN} && curl -k -sS -D - -o /dev/null -H 'Range: bytes=0-1' \"https://lectio.tw1.ru/api/schedule/recordings/14/stream/?token=$TOKEN\" | sed -n '1,25p'"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: deploy stream token refresh",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel && sudo git fetch origin main && sudo git reset --hard origin/main && cd frontend && npm run build && sudo systemctl restart teaching_panel && echo DEPLOY_OK && sudo systemctl is-active teaching_panel"
			],
			"isBackground": false,
			"problemMatcher": [],
			"group": "build"
		},
		{
			"label": "prod: stream headers check (range)",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"bash -lc \"cd /var/www/teaching_panel/teaching_panel && source ../venv/bin/activate && python -c 'from django.contrib.auth import get_user_model; from rest_framework_simplejwt.tokens import AccessToken; import ssl,http.client,urllib.parse; u=get_user_model().objects.get(id=4); token=str(AccessToken.for_user(u)); conn=http.client.HTTPSConnection(\\\"lectio.tw1.ru\\\", context=ssl.create_default_context(), timeout=30); path=\\\"/api/schedule/recordings/14/stream/?token=\\\"+urllib.parse.quote(token); conn.request(\\\"GET\\\", path, headers={\\\"Range\\\":\\\"bytes=0-1\\\"}); resp=conn.getresponse(); print(\\\"STATUS\\\", resp.status, resp.reason); print(\\\"content-type:\\\", resp.getheader(\\\"Content-Type\\\")); print(\\\"content-range:\\\", resp.getheader(\\\"Content-Range\\\")); print(\\\"accept-ranges:\\\", resp.getheader(\\\"Accept-Ranges\\\")); print(\\\"content-length:\\\", resp.getheader(\\\"Content-Length\\\")); data=resp.read(16); print(\\\"BODY_PREFIX_HEX\\\", data.hex())'\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: stream headers check (venv python)",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"/var/www/teaching_panel/venv/bin/python /var/www/teaching_panel/teaching_panel/manage.py shell -c \"from django.contrib.auth import get_user_model; from rest_framework_simplejwt.tokens import AccessToken; import ssl,http.client,urllib.parse; u=get_user_model().objects.get(id=4); token=str(AccessToken.for_user(u)); conn=http.client.HTTPSConnection('lectio.tw1.ru', context=ssl.create_default_context(), timeout=30); path='/api/schedule/recordings/14/stream/?token='+urllib.parse.quote(token); conn.request('GET', path, headers={'Range':'bytes=0-1'}); resp=conn.getresponse(); print('STATUS', resp.status, resp.reason); print('content-type:', resp.getheader('Content-Type')); print('content-range:', resp.getheader('Content-Range')); print('accept-ranges:', resp.getheader('Accept-Ranges')); print('content-length:', resp.getheader('Content-Length')); data=resp.read(16); print('BODY_PREFIX_HEX', data.hex())\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: echo sanity",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"echo HI"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: venv python version quick",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"/var/www/teaching_panel/venv/bin/python -V"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: manage.py shell -c sanity",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"/var/www/teaching_panel/venv/bin/python /var/www/teaching_panel/teaching_panel/manage.py shell -c \"print('OK')\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: manage.py shell --help (head)",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"/var/www/teaching_panel/venv/bin/python /var/www/teaching_panel/teaching_panel/manage.py shell --help | sed -n '1,80p'"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: django setup sanity (python -c)",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel/teaching_panel && /var/www/teaching_panel/venv/bin/python -c \"import os; os.environ.setdefault('DJANGO_SETTINGS_MODULE','teaching_panel.settings'); import django; django.setup(); print('OK')\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: python stderr capture sanity",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel/teaching_panel && /var/www/teaching_panel/venv/bin/python -c \"print('HI')\" > /tmp/py_sanity.txt 2>&1; echo DONE; tail -n 20 /tmp/py_sanity.txt"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: basic shell output",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"pwd; echo AAA; ls -la /tmp | sed -n '1,5p'"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: manage.py shell heredoc sanity",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel/teaching_panel && /var/www/teaching_panel/venv/bin/python manage.py shell <<'PY'\nprint('OK')\nexit()\nPY"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: check app logs",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"sudo tail -n 50 /var/log/teaching_panel/error.log"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: get token",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel/teaching_panel && ../venv/bin/python manage.py shell -c \"from django.contrib.auth import get_user_model; from rest_framework_simplejwt.tokens import AccessToken; u=get_user_model().objects.get(id=4); print('TOKEN:' + str(AccessToken.for_user(u)))\""
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: deploy backend logs",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel && sudo git fetch origin main && sudo git reset --hard origin/main && sudo systemctl restart teaching_panel && echo RESTART_OK"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: cat nginx config",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cat /etc/nginx/sites-enabled/teaching_panel"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: grep stream debug logs",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"sudo tail -n 100 /var/log/teaching_panel/error.log | grep STREAM_DEBUG"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: check urls.py",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cat /var/www/teaching_panel/teaching_panel/teaching_panel/urls.py"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: deploy and tail logs",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel && sudo git fetch origin main && sudo git reset --hard origin/main && sudo systemctl restart teaching_panel && echo DEPLOY_LOGS_OK && sudo tail -f /var/log/teaching_panel/error.log"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: check permissions",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"ls -la /var/www/teaching_panel/teaching_panel"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: run test script as www-data",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cat > /tmp/test_stream.py <<'EOF'\nimport os\nimport django\nimport sys\nimport logging\n\nos.environ.setdefault(\"DJANGO_SETTINGS_MODULE\", \"teaching_panel.settings\")\ndjango.setup()\n\nfrom schedule.models import LessonRecording\nfrom schedule.gdrive_utils import get_gdrive_manager\nfrom google.auth.transport.requests import AuthorizedSession\n\nrec_id = 14\ntry:\n    rec = LessonRecording.objects.get(id=rec_id)\n    print(f\"Recording {rec_id} found. File ID: {rec.gdrive_file_id}\")\n    \n    gdrive = get_gdrive_manager()\n    creds = getattr(getattr(gdrive.service, \"_http\", None), \"credentials\", None)\n    \n    session = AuthorizedSession(creds)\n    drive_url = f\"https://www.googleapis.com/drive/v3/files/{rec.gdrive_file_id}?alt=media\"\n    \n    print(\"Starting request as user:\", os.environ.get(\"USER\"), os.getuid())\n    resp = session.get(drive_url, stream=True, timeout=30)\n    print(f\"Response status: {resp.status_code}\")\n    print(f\"Headers: {resp.headers}\")\n    \n    chunk = next(resp.iter_content(chunk_size=1024))\n    print(f\"First chunk read: {len(chunk)} bytes\")\n\nexcept Exception as e:\n    print(f\"Error: {e}\")\nEOF\nsudo -u www-data /var/www/teaching_panel/venv/bin/python /tmp/test_stream.py"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: check apps.py",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cat /var/www/teaching_panel/teaching_panel/schedule/apps.py"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "prod: deploy perf fix",
			"type": "shell",
			"command": "ssh",
			"args": [
				"tp",
				"cd /var/www/teaching_panel && sudo git fetch origin main && sudo git reset --hard origin/main && sudo systemctl restart teaching_panel && echo DEPLOY_PERF_OK"
			],
			"isBackground": false,
			"problemMatcher": []
		},
		{
			"label": "build-frontend-errors-fix",
			"type": "shell",
			"command": "cd frontend && npm run build",
			"isBackground": false
		}
	]
}